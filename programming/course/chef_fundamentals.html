---
title: "Chef Fundamentals"
---
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-06-16 Sun 19:39 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chef Fundamentals</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Victor Chen" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="../../styles/readtheorg/css/font.css"/>
<link rel="stylesheet" type="text/css" href="../../styles/readtheorg/css/readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="../../styles/readtheorg/css/htmlize.css"/>
<script type="text/javascript" src="../../styles/readtheorg/js/jquery.min.js"></script>
<script type="text/javascript" src="../../styles/readtheorg/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Chef Fundamentals</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org7d01cdb">1 Welcome to Chef Fundamentals</a>
<ul>
<li><a href="#org14acedc">1.1 Install ChefDK</a></li>
<li><a href="#org20f657a">1.2 Configure Lab Environment with Vagrant and Virtualbox</a></li>
<li><a href="#orgdbd5f3e">1.3 Configure Lab Environment with AWS</a></li>
<li><a href="#orgb5c9d3e">1.4 Configure Lab Environment with GCP</a></li>
</ul>
</li>
<li><a href="#orga3ff73e">2 Chef and Configuration Management</a>
<ul>
<li><a href="#orgea5b0d9">2.1 First Chef Recipe</a></li>
</ul>
</li>
<li><a href="#org7f529da">3 Resources</a>
<ul>
<li><a href="#org5cbe802">3.1 Create a Workstation Setup Recipe</a></li>
</ul>
</li>
<li><a href="#orgcdf74f1">4 Cookbooks</a>
<ul>
<li><a href="#org38ed508">4.1 Deploy an Apache Web Server</a></li>
</ul>
</li>
<li><a href="#org3389b50">5 Chef Client</a>
<ul>
<li><a href="#org44c4351">5.1 Apply Recipes and Cookbooks</a></li>
<li><a href="#org89a2430">5.2 The include_recipe Method</a></li>
</ul>
</li>
<li><a href="#org8a406aa">6 Ohai</a>
<ul>
<li><a href="#org556cb7c">6.1 An Object Called "Node"</a></li>
<li><a href="#org90e06d5">6.2 Access Node Attributes</a></li>
</ul>
</li>
<li><a href="#orgd3616ba">7 Templates</a>
<ul>
<li><a href="#orgbadd189">7.1 Understand Embedded Ruby</a></li>
</ul>
</li>
<li><a href="#orgf1f927e">8 Other Common Resources</a>
<ul>
<li><a href="#org90999de">8.1 cookbook_file</a></li>
<li><a href="#org8abe43b">8.2 remote_file</a></li>
<li><a href="#org99da2c4">8.3 execute</a></li>
<li><a href="#orgb6684cd">8.4 user and group</a></li>
<li><a href="#org86d40e3">8.5 Send and Receive Notifications</a></li>
</ul>
</li>
<li><a href="#org55df4a9">9 Troubleshooting and Bonus Content</a>
<ul>
<li><a href="#org1dbf467">9.1 Explore the ChefDK</a></li>
<li><a href="#orgab1cc07">9.2 Chef Toolkit</a></li>
<li><a href="#orgbbad438">9.3 Intro to Test Kitchen</a></li>
<li><a href="#orgec29670">9.4 Intro to ChefSpec</a></li>
</ul>
</li>
<li><a href="#org405c3ed">10 Chef Server</a>
<ul>
<li><a href="#orgc480bfb">10.1 Why Use A Chef Server?</a></li>
<li><a href="#org2efcea7">10.2 Get Started with Hosted Chef</a></li>
<li><a href="#org168ec7f">10.3 Upload Cookbooks</a></li>
<li><a href="#orgabd45e4">10.4 Reconfigure Vagrant Environment</a></li>
<li><a href="#org9b2fc83">10.5 Bootstrap Web Server</a></li>
</ul>
</li>
<li><a href="#org4ca4e15">11 Community Cookbooks</a>
<ul>
<li><a href="#org60c6b21">11.1 Explore the Supermarket</a></li>
<li><a href="#org0c4f026">11.2 Create a Wrapper Cookbook</a></li>
<li><a href="#org6557567">11.3 Add Web Server Members</a></li>
<li><a href="#org7644e3e">11.4 Manage Cookbooks with Berkshelf</a></li>
<li><a href="#org0a364e9">11.5 Bootstrap Load Balancer</a></li>
</ul>
</li>
<li><a href="#orgc732050">12 Manage Nodes</a>
<ul>
<li><a href="#org57dd0e0">12.1 Run chef-client on a Schedule</a></li>
</ul>
</li>
<li><a href="#org2b587d1">13 Roles</a>
<ul>
<li><a href="#orgdadb895">13.1 Create and Assign Roles</a></li>
<li><a href="#org74e0017">13.2 Converge Using the <code>knife ssh</code> Command</a></li>
</ul>
</li>
<li><a href="#org995d167">14 Search</a>
<ul>
<li><a href="#org5d9a0a5">14.1 Explore Chef Server Indices</a></li>
<li><a href="#orgd785c4b">14.2 Run Searches with Knife</a></li>
<li><a href="#orgdb57a47">14.3 Refactor for Dynamic Load Balancing</a></li>
</ul>
</li>
<li><a href="#orgeb976e0">15 Environments</a>
<ul>
<li><a href="#org0331aef">15.1 Create and Manage a Production Environment</a></li>
<li><a href="#org77751c4">15.2 Refine the Load Balancer</a></li>
</ul>
</li>
<li><a href="#org3d6d03c">16 Data Bags</a>
<ul>
<li><a href="#orgbffba4a">16.1 What's in the Bag?</a></li>
<li><a href="#org1f89857">16.2 Create and Manage Data Bags</a></li>
<li><a href="#org7ea1ee5">16.3 Dynamic Search and Find</a></li>
<li><a href="#org56e461f">16.4 Encrypt Secrets</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org7d01cdb" class="outline-2">
<h2 id="org7d01cdb"><span class="section-number-2">1</span> Welcome to Chef Fundamentals</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-org14acedc" class="outline-3">
<h3 id="org14acedc"><span class="section-number-3">1.1</span> Install ChefDK</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Download ChefDK at <a href="https://downloads.chef.io/chefdk">Chef Downloads</a> and install on local machine. Confirm installation by:
</p>

<div class="org-src-container">
<pre class="src src-sh">chef --version
</pre>
</div>
</div>
</div>

<div id="outline-container-org20f657a" class="outline-3">
<h3 id="org20f657a"><span class="section-number-3">1.2</span> Configure Lab Environment with Vagrant and Virtualbox</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Confirm Vagrant and Virtualbox are installed:
</p>

<div class="org-src-container">
<pre class="src src-sh">vboxmanage --version
vagrant --version
</pre>
</div>

<p>
Create a Vagrant box and SSH into it:
</p>

<div class="org-src-container">
<pre class="src src-sh">vagrant box add bento/centos-7.2 --provider=virtualbox
vagrant init bento/centos-7.2 <span class="org-comment-delimiter"># </span><span class="org-comment">Vagrantfile is created</span>
vagrant up
vagrant ssh
</pre>
</div>

<p>
Install ChefDK in Vagrant box:
</p>

<div class="org-src-container">
<pre class="src src-sh">curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P chefdk -c stable -v 3.10.1
chef --version
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdbd5f3e" class="outline-3">
<h3 id="orgdbd5f3e"><span class="section-number-3">1.3</span> Configure Lab Environment with AWS</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Launch an EC2 instance:
</p>

<ul class="org-ul">
<li>AMI: CentOS 7</li>
<li>Security groups: Enable HTTP/HTTPS ports</li>
<li>Key pairs: Create key pair <code>centos7</code> and download the private key file <code>centos7.pem</code></li>
</ul>

<p>
Connect to the instance via SSH:
</p>

<div class="org-src-container">
<pre class="src src-sh">chmod 400 centos7.pem
ssh -i centos7.pem centos@ec2-3-84-192-46.compute-1.amazonaws.com
</pre>
</div>

<p>
Install ChefDK on the instance:
</p>

<div class="org-src-container">
<pre class="src src-sh">curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P chefdk -c stable -v 3.10.1
chef --version
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb5c9d3e" class="outline-3">
<h3 id="orgb5c9d3e"><span class="section-number-3">1.4</span> Configure Lab Environment with GCP</h3>
<div class="outline-text-3" id="text-1-4">
<ol class="org-ol">
<li>Create a project on GCP.</li>
<li>Go to <a href="https://console.cloud.google.com/compute/instances">GCP | Compute Engine | VM Instances</a> and create an instance:
<ul class="org-ul">
<li>Boot disk: CentOS 7</li>
<li>Firewall: Allow HTTP/HTTPS traffic</li>
<li>SSH keys: Paste the public key of the key pair to use for SSH connection (<code>ssh-gen</code> a new key pair if necessary)</li>
</ul></li>
</ol>

<p>
Connect to the instance via GCP browser SSH or SSH client:
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh -i &lt;private_key&gt; &lt;user&gt;@&lt;external_ip&gt;
</pre>
</div>

<p>
Install ChefDK on the instance:
</p>

<div class="org-src-container">
<pre class="src src-sh">curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P chefdk -c stable -v 3.10.1
chef --version
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga3ff73e" class="outline-2">
<h2 id="orga3ff73e"><span class="section-number-2">2</span> Chef and Configuration Management</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-orgea5b0d9" class="outline-3">
<h3 id="orgea5b0d9"><span class="section-number-3">2.1</span> First Chef Recipe</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Create a simple recipe:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span><code>hello.rb</code></label><pre class="src src-ruby">file <span class="org-string">'/hello.txt'</span> <span class="org-keyword">do</span> <span class="org-comment-delimiter"># </span><span class="org-comment">Create a file</span>
  content <span class="org-string">'Hello, world!'</span> <span class="org-comment-delimiter"># </span><span class="org-comment">Specify content of the file</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
Apply the recipe to current node:
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo chef-client --local-mode hello.rb
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7f529da" class="outline-2">
<h2 id="org7f529da"><span class="section-number-2">3</span> Resources</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-org5cbe802" class="outline-3">
<h3 id="org5cbe802"><span class="section-number-3">3.1</span> Create a Workstation Setup Recipe</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Create a recipe to install 2 services and 1 file:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span><code>setup.rb</code></label><pre class="src src-ruby">package <span class="org-string">'tree'</span> <span class="org-keyword">do</span>
  action <span class="org-constant">:install</span>
<span class="org-keyword">end</span>

package <span class="org-string">'ntp'</span> <span class="org-keyword">do</span>
  action <span class="org-constant">:install</span>
<span class="org-keyword">end</span>

service <span class="org-string">'ntpd'</span> <span class="org-keyword">do</span>
  action [ <span class="org-constant">:enable</span>, <span class="org-constant">:start</span> ]
<span class="org-keyword">end</span>

file <span class="org-string">'/etc/motd'</span> <span class="org-keyword">do</span>
  action <span class="org-constant">:create</span>
  content <span class="org-string">'This is the property of ...'</span>
  owner <span class="org-string">'root'</span>
  group <span class="org-string">'root'</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcdf74f1" class="outline-2">
<h2 id="orgcdf74f1"><span class="section-number-2">4</span> Cookbooks</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-org38ed508" class="outline-3">
<h3 id="org38ed508"><span class="section-number-3">4.1</span> Deploy an Apache Web Server</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Generate a cookbook and a recipe:
</p>

<div class="org-src-container">
<pre class="src src-sh">chef generate cookbook cookbooks/apache
chef generate recipe cookbooks/apache server
</pre>
</div>

<p>
Edit the recipe:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span><code>cookbooks/apache/recipes/server.rb</code></label><pre class="src src-ruby">package <span class="org-string">'httpd'</span> <span class="org-keyword">do</span>
  action <span class="org-constant">:install</span>
<span class="org-keyword">end</span>

file <span class="org-string">'/var/www/html/index.html'</span> <span class="org-keyword">do</span>
  action <span class="org-constant">:create</span>
  content <span class="org-string">'Apache is working.'</span>
  owner <span class="org-string">'apache'</span>
  group <span class="org-string">'apache'</span>
<span class="org-keyword">end</span>

service <span class="org-string">'httpd'</span> <span class="org-keyword">do</span>
  action [ <span class="org-constant">:enable</span>, <span class="org-constant">:start</span> ]
<span class="org-keyword">end</span>
</pre>
</div>

<p>
Check syntax of the recipe and execute it:
</p>

<div class="org-src-container">
<pre class="src src-sh">chef exec ruby -c cookbooks/apache/recipes/server.rb
sudo chef-client -z cookbooks/apache/recipes/server.rb
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3389b50" class="outline-2">
<h2 id="org3389b50"><span class="section-number-2">5</span> Chef Client</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-org44c4351" class="outline-3">
<h3 id="org44c4351"><span class="section-number-3">5.1</span> Apply Recipes and Cookbooks</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Run <code>chef-client</code> by providing a runlist:
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo chef-client -z --runlist <span class="org-string">"apache::server"</span>
sudo chef-client -z --runlist <span class="org-string">"recipe[apache::server],recipe[workstation::setup]"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org89a2430" class="outline-3">
<h3 id="org89a2430"><span class="section-number-3">5.2</span> The include_recipe Method</h3>
<div class="outline-text-3" id="text-5-2">
<p>
Include a recipe from the default recipe:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span><code>cookbooks/apache/recipes/default.rb</code></label><pre class="src src-ruby">include_recipe <span class="org-string">'apache::server'</span>
</pre>
</div>

<p>
Run the default recipe and confirm that the included recipe is run as well:
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo chef-client -z --runlist <span class="org-string">"recipe[apache]"</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8a406aa" class="outline-2">
<h2 id="org8a406aa"><span class="section-number-2">6</span> Ohai</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-org556cb7c" class="outline-3">
<h3 id="org556cb7c"><span class="section-number-3">6.1</span> An Object Called "Node"</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Chef provides the Ohai tool which is used to collect the node's info to be used in recipes. Ohai runs every time Chef Client runs, and it creates a <code>node</code> object containing the node's info.
</p>

<p>
The command <code>ohai</code> returns the same info.
</p>
</div>
</div>

<div id="outline-container-org90e06d5" class="outline-3">
<h3 id="org90e06d5"><span class="section-number-3">6.2</span> Access Node Attributes</h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span><code>cookbooks/workstation/recipes/setup.rb</code></label><pre class="src src-ruby">file <span class="org-string">'/etc/motd'</span> <span class="org-keyword">do</span>
  content <span class="org-string">"</span>
<span class="org-string">This is the property of ...</span>
<span class="org-string">Hostname: </span><span class="org-variable-name">#{node['hostname']}</span>
<span class="org-string">IP: </span><span class="org-variable-name">#{node['ipaddress']}</span>
<span class="org-string">CPU: </span><span class="org-variable-name">#{node['cpu']['0']['mhz']}</span>
<span class="org-string">Memory: </span><span class="org-variable-name">#{node['memory']['total']}</span>
<span class="org-string">"</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd3616ba" class="outline-2">
<h2 id="orgd3616ba"><span class="section-number-2">7</span> Templates</h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-orgbadd189" class="outline-3">
<h3 id="orgbadd189"><span class="section-number-3">7.1</span> Understand Embedded Ruby</h3>
<div class="outline-text-3" id="text-7-1">
<p>
Generate a Chef template:
</p>

<div class="org-src-container">
<pre class="src src-sh">chef generate template cookbooks/workstation motd
</pre>
</div>

<p>
Edit the template file:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span><code>cookbooks/workstation/templates/motd.erb</code></label><pre class="src src-erb">This is the property <span class="org-web-mode-keyword">of</span> ...
<span class="org-web-mode-variable-name">Hostname</span>: &lt;%= node['hostname'] %&gt;
<span class="org-web-mode-variable-name">IP</span>: &lt;%= node['ipaddress'] %&gt;
<span class="org-web-mode-variable-name">CPU</span>: &lt;%= node['cpu']['0']['mhz'] %&gt;
<span class="org-web-mode-variable-name">Memory</span>: &lt;%= node['memory']['total'] %&gt;
<span class="org-web-mode-variable-name">Name</span>: &lt;%= <span class="org-web-mode-keyword">@name</span> %&gt;
</pre>
</div>

<p>
Add a <code>template</code> resource to use the template in the recipe:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span><code>cookbooks/workstation/recipes/setup.rb</code></label><pre class="src src-ruby">template <span class="org-string">'/etc/motd'</span> <span class="org-keyword">do</span>
  action <span class="org-constant">:create</span>
  source <span class="org-string">'motd.erb'</span>
  variables(
    <span class="org-constant">:name</span> =&gt; <span class="org-string">'Victor'</span>
  )
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf1f927e" class="outline-2">
<h2 id="orgf1f927e"><span class="section-number-2">8</span> Other Common Resources</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-org90999de" class="outline-3">
<h3 id="org90999de"><span class="section-number-3">8.1</span> cookbook_file</h3>
<div class="outline-text-3" id="text-8-1">
<p>
Generate a Chef file:
</p>

<pre class="example">
chef generate file cookbooks/apache index.html
</pre>

<p>
Add a <code>cookbook_file</code> resource in the recipe:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span><code>cookbooks/apache/recipes/server.rb</code></label><pre class="src src-ruby">cookbook_file <span class="org-string">'/var/www/html/index.html'</span> <span class="org-keyword">do</span>
  action <span class="org-constant">:create</span>
  source <span class="org-string">'index.html'</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8abe43b" class="outline-3">
<h3 id="org8abe43b"><span class="section-number-3">8.2</span> remote_file</h3>
<div class="outline-text-3" id="text-8-2">
<p>
Add a <code>remote_file</code> resource in the recipe, and pass the file path as variable to the template file:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span><code>cookbooks/apache/recipes/server.rb</code></label><pre class="src src-ruby">remote_file <span class="org-string">'/var/www/html/image.jpg'</span> <span class="org-keyword">do</span>
  action <span class="org-constant">:create</span>
  source <span class="org-string">'https://picsum.photos/200.jpg'</span>
<span class="org-keyword">end</span>

template <span class="org-string">'/var/www/html/index.html'</span> <span class="org-keyword">do</span>
  action <span class="org-constant">:create</span>
  source <span class="org-string">'index.html.erb'</span>
  variables(
    <span class="org-constant">:image</span> =&gt; <span class="org-string">'image.jpg'</span>
  )
<span class="org-keyword">end</span>
</pre>
</div>

<p>
Edit the template:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span><code>cookbooks/apache/templates/index.html.erb</code></label><pre class="src src-html">&lt;<span class="org-function-name">h1</span>&gt;<span class="org-bold"><span class="org-underline">Here is an image.</span></span>&lt;/<span class="org-function-name">h1</span>&gt;
&lt;<span class="org-function-name">img</span> <span class="org-variable-name">src</span>=<span class="org-string">"&lt;%= @image %&gt;"</span> /&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-org99da2c4" class="outline-3">
<h3 id="org99da2c4"><span class="section-number-3">8.3</span> execute</h3>
<div class="outline-text-3" id="text-8-3">
<p>
3 different ways to create a directory and set the owner as <code>apache</code>:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span><code>cookbooks/apache/recipes/server.rb</code></label><pre class="src src-ruby">bash <span class="org-string">'mysites'</span> <span class="org-keyword">do</span>
  user <span class="org-string">'root'</span>
  code <span class="org-string">'mkdir -p /var/www/mysites/ &amp;&amp; chown -R apache /var/www/mysites/'</span>
  not_if <span class="org-string">'[ -d /var/www/mysites/ ]'</span>
<span class="org-keyword">end</span>

execute <span class="org-string">'mysites'</span> <span class="org-keyword">do</span>
  user <span class="org-string">'root'</span>
  command <span class="org-string">&lt;&lt;-EOH</span>
<span class="org-string">    mkdir -p /var/www/mysites/</span>
<span class="org-string">    chown -R apache /var/www/mysites/</span>
<span class="org-string">  EOH</span>
  not_if <span class="org-string">'[ -d /var/www/mysites/ ]'</span>
<span class="org-keyword">end</span>

directory <span class="org-string">'/var/www/mysites/'</span> <span class="org-keyword">do</span>
  owner <span class="org-string">'apache'</span>
  recursive <span class="org-constant">true</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb6684cd" class="outline-3">
<h3 id="orgb6684cd"><span class="section-number-3">8.4</span> user and group</h3>
<div class="outline-text-3" id="text-8-4">
<p>
Create a user and a group, and assign the user to the group:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span><code>cookbooks/workstation/recipes/setup.rb</code></label><pre class="src src-ruby">user <span class="org-string">'user1'</span> <span class="org-keyword">do</span>
  home <span class="org-string">'/home/user1'</span>
  shell <span class="org-string">'/bin/bash'</span>
<span class="org-keyword">end</span>

group <span class="org-string">'admins'</span> <span class="org-keyword">do</span>
  members [<span class="org-string">'user1'</span>]
  append <span class="org-constant">true</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org86d40e3" class="outline-3">
<h3 id="org86d40e3"><span class="section-number-3">8.5</span> Send and Receive Notifications</h3>
<div class="outline-text-3" id="text-8-5">
<p>
2 ways to restart <code>httpd</code> when a <code>template</code> resource is updated:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 13: </span><code>cookbooks/apache/recipes/server.rb</code></label><pre class="src src-ruby">template <span class="org-string">'/var/www/html/index.html'</span> <span class="org-keyword">do</span>
  source <span class="org-string">'index.html.erb'</span>
  notifies <span class="org-constant">:restart</span>, <span class="org-string">'service[httpd]'</span>, <span class="org-constant">:immediately</span>
<span class="org-keyword">end</span>

service <span class="org-string">'httpd'</span> <span class="org-keyword">do</span>
  action [<span class="org-constant">:enable</span>, <span class="org-constant">:start</span>]
<span class="org-keyword">end</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 14: </span><code>cookbooks/apache/recipes/server.rb</code></label><pre class="src src-ruby">template <span class="org-string">'/var/www/html/index.html'</span> <span class="org-keyword">do</span>
  source <span class="org-string">'index.html.erb'</span>
<span class="org-keyword">end</span>

service <span class="org-string">'httpd'</span> <span class="org-keyword">do</span>
  action [<span class="org-constant">:enable</span>, <span class="org-constant">:start</span>]
  subscribes <span class="org-constant">:restart</span>, <span class="org-string">'template[/var/www/html/index.html]'</span>, <span class="org-constant">:immediately</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org55df4a9" class="outline-2">
<h2 id="org55df4a9"><span class="section-number-2">9</span> Troubleshooting and Bonus Content</h2>
<div class="outline-text-2" id="text-9">
</div><div id="outline-container-org1dbf467" class="outline-3">
<h3 id="org1dbf467"><span class="section-number-3">9.1</span> Explore the ChefDK</h3>
<div class="outline-text-3" id="text-9-1">
<p>
When Chef is installed, an embedded Ruby is installed with it, which is separate from the local globally installed Ruby:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ruby -v
-bash: ruby: command not found <span class="org-comment-delimiter"># </span><span class="org-comment">Ruby is not installed globally</span>
$ chef exec ruby -v
ruby 2.5.5p157 ... <span class="org-comment-delimiter"># </span><span class="org-comment">Ruby is installed in embedded context</span>
</pre>
</div>

<p>
Check Ruby syntax of Chef recipes:
</p>

<div class="org-src-container">
<pre class="src src-sh">chef exec ruby -c cookbooks/*/recipes/*.rb
</pre>
</div>
</div>
</div>

<div id="outline-container-orgab1cc07" class="outline-3">
<h3 id="orgab1cc07"><span class="section-number-3">9.2</span> Chef Toolkit</h3>
<div class="outline-text-3" id="text-9-2">
<p>
If a Chef tool is not available directly (because the include path is not configured), try using it with the embedded context:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ rspec -v
-bash: rspec: command not found
$ chef exec rspec -v
RSpec 3.8
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbbad438" class="outline-3">
<h3 id="orgbbad438"><span class="section-number-3">9.3</span> Intro to Test Kitchen</h3>
<div class="outline-text-3" id="text-9-3">
<p>
Update the Test Kitchen config file:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 15: </span><code>cookbooks/apache/.kitchen.yml</code></label><pre class="src src-yaml"><span class="org-variable-name">provisioner</span>:
  <span class="org-variable-name">name</span>: chef_zero
  <span class="org-variable-name">always_update_cookbooks</span>: <span class="org-constant">true</span>
  <span class="org-comment-delimiter"># </span><span class="org-comment">Add these 2 lines:</span>
  <span class="org-variable-name">client_rb</span>:
<span class="org-yaml-tab">    </span><span class="org-variable-name">chef_license</span>: accept
</pre>
</div>

<p>
Write integration tests by following <a href="https://www.inspec.io/docs/reference/resources/">InSpec Resources Reference</a>:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 16: </span><code>cookbooks/apache/test/integration/default/server_test.rd</code></label><pre class="src src-ruby">describe port(80) <span class="org-keyword">do</span>
  it { should be_listening }
<span class="org-keyword">end</span>

describe command(<span class="org-string">'curl localhost'</span>) <span class="org-keyword">do</span>
  its(<span class="org-constant">:stdout</span>) { should match(<span class="org-string">/Hello, world!/</span>) }
<span class="org-keyword">end</span>
</pre>
</div>

<p>
Run tests with Test Kitchen from local environment (not from within the Vagrant):
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cd cookbooks/apache
$ kitchen create
$ kitchen list <span class="org-comment-delimiter"># </span><span class="org-comment">Confirm instance is created</span>
Instance             Driver   Provisioner  Verifier  Transport  Last Action  Last Error
default-ubuntu-1604  Vagrant  ChefZero     Inspec    Ssh        Created      &lt;None&gt;
$ kitchen login <span class="org-comment-delimiter"># </span><span class="org-comment">Connect to instance</span>
&gt; curl localhost <span class="org-comment-delimiter"># </span><span class="org-comment">Confirm httpd is not running</span>
curl: (7) Failed connect to localhost:80; Connection refused
&gt; exit
$ kitchen converge <span class="org-comment-delimiter"># </span><span class="org-comment">Install Chef on the instance and converge (apply the recipes)</span>
$ kitchen login
&gt; curl localhost <span class="org-comment-delimiter"># </span><span class="org-comment">Confirm httpd is running</span>
&lt;html&gt;...
&gt; exit
$ kitchen verify <span class="org-comment-delimiter"># </span><span class="org-comment">Run integration tests</span>
Test Summary: 2 successful, 0 failures, 0 skipped
</pre>
</div>
</div>
</div>

<div id="outline-container-orgec29670" class="outline-3">
<h3 id="orgec29670"><span class="section-number-3">9.4</span> Intro to ChefSpec</h3>
<div class="outline-text-3" id="text-9-4">
<p>
Running integration tests with InSpec needs external dependencies (driver etc.) and is slow. Running unit tests with ChefSpec is simpler and faster.
</p>

<p>
Write unit test:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 17: </span><code>cookbooks/apache/spec/unit/recipes/server_spec.rb</code></label><pre class="src src-ruby"><span class="org-builtin">require</span> <span class="org-string">'spec_helper'</span>

describe <span class="org-string">'apache::server'</span> <span class="org-keyword">do</span>
  context <span class="org-string">'When all attributes are default, on an unspecified platform'</span> <span class="org-keyword">do</span>
    let(<span class="org-constant">:chef_run</span>) <span class="org-keyword">do</span>
      runner = <span class="org-type">ChefSpec</span>::<span class="org-type">ServerRunner</span>.new
      runner.converge(described_recipe)
    <span class="org-keyword">end</span>

    it <span class="org-string">'installs the correct package'</span> <span class="org-keyword">do</span>
      expect(chef_run).to install_package(<span class="org-string">'httpd'</span>)
    <span class="org-keyword">end</span>

    it <span class="org-string">'creates an default html file'</span> <span class="org-keyword">do</span>
      expect(chef_run).to create_template(<span class="org-string">'/var/www/html/index.html'</span>)
    <span class="org-keyword">end</span>

    it <span class="org-string">'enables the service'</span> <span class="org-keyword">do</span>
      expect(chef_run).to enable_service(<span class="org-string">'httpd'</span>)
    <span class="org-keyword">end</span>

    it <span class="org-string">'starts the service'</span> <span class="org-keyword">do</span>
      expect(chef_run).to start_service(<span class="org-string">'httpd'</span>)
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
Add unit test coverage:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 18: </span><code>cookbooks/apache/spec/spec_helper.rb</code></label><pre class="src src-ruby"><span class="org-type">ChefSpec</span>::<span class="org-type">Coverage</span>.start!
</pre>
</div>

<p>
Run unit test:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cd cookbooks/apache
$ chef exec rspec spec/unit/recipes/server_spec.rb
4 examples, 0 failures
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org405c3ed" class="outline-2">
<h2 id="org405c3ed"><span class="section-number-2">10</span> Chef Server</h2>
<div class="outline-text-2" id="text-10">
</div><div id="outline-container-orgc480bfb" class="outline-3">
<h3 id="orgc480bfb"><span class="section-number-3">10.1</span> Why Use A Chef Server?</h3>
<div class="outline-text-3" id="text-10-1">
<p>
Without using Chef Server, provisioning multiple nodes will be:
</p>

<ol class="org-ol">
<li>Install Chef tools on each node.</li>
<li>Pull cookbooks onto the node, via Git or SCP.</li>
<li>Run Chef Client in local mode to apply the recipes.</li>
</ol>
</div>
</div>

<div id="outline-container-org2efcea7" class="outline-3">
<h3 id="org2efcea7"><span class="section-number-3">10.2</span> Get Started with Hosted Chef</h3>
<div class="outline-text-3" id="text-10-2">
<p>
<a href="https://manage.chef.io">Chef Manage</a> is free manager Chef Server provided by Chef.
</p>

<ol class="org-ol">
<li>Sign up to Chef Manage.</li>
<li>Create an organization.</li>
<li>Select the organization, go to Starter Kit, and click Download Starter Kit.</li>
<li>Move the <code>chef-repo</code> directory to a proper location.</li>
<li>Replace the <code>chef-repo/cookbooks</code> directory with the <code>cookbooks</code> directory to use.</li>
</ol>

<p>
NOTE: There is a special recipe to include into the <code>workstation</code> cookbook:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 19: </span><code>chef-repo/cookbooks/workstation/recipes/vagrant.rb</code></label><pre class="src src-ruby"><span class="org-comment-delimiter"># </span><span class="org-comment">if you found this recipe you're probably wondering what it's for!</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">we do not cover ohai plugins in this class, but it's the process of modifying</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">the information added to the node object at the beginning of a chef-client run.</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">the vagrant-ohai plugin modifes the node['ipaddress'] attribute gathered by ohai</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">to match what we define in the Vagrant file. Otherwise ohai will detect the internal</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">ipaddress assigned by vagrant. This allows our load balancer to work with the</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">virtual instances we manage later in the class.</span>
<span class="org-comment-delimiter">#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">@see https://github.com/avishai-ish-shalom/vagrant-ohai</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">@see https://docs.chef.io/ohai_custom.html</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">execute sudo /etc/init.d/network restart to reload the networking interfaces</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">this problem seems confined to Vagrant 1.9.1</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">see vagrant issue https://github.com/mitchellh/vagrant/issues/8115</span>
execute <span class="org-string">'reload network interfaces'</span> <span class="org-keyword">do</span>
  command <span class="org-string">'sudo /etc/init.d/network restart'</span>
  not_if <span class="org-string">"ifconfig | grep 'eth0'"</span>
<span class="org-keyword">end</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">set plugin path for ohai if not already defined in /etc/chef/client.rb</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">this is always set on a subsequent chef-client run because of ruby_block[configure ohai plugin path]</span>
<span class="org-keyword">if</span> ::<span class="org-type">Ohai</span>::<span class="org-type">Config</span>.ohai.nil?
  ::<span class="org-type">Ohai</span>::<span class="org-type">Config</span>[<span class="org-string">'plugin_path'</span>] &lt;&lt; <span class="org-string">'/etc/chef/ohai_plugins'</span> <span class="org-comment-delimiter"># </span><span class="org-comment">old format</span>
<span class="org-keyword">else</span>
  ::<span class="org-type">Ohai</span>::<span class="org-type">Config</span>.ohai[<span class="org-string">'plugin_path'</span>] &lt;&lt; <span class="org-string">'/etc/chef/ohai_plugins'</span> <span class="org-comment-delimiter"># </span><span class="org-comment">new format</span>
<span class="org-keyword">end</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">add vagrant-ohai plugin to the resource collection</span>
<span class="org-comment-delimiter">#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">@see https://docs.chef.io/resource_ohai.html</span>
ohai <span class="org-string">'vagrant-ipaddress'</span> <span class="org-keyword">do</span>
  plugin <span class="org-string">'ipaddress'</span>
  action <span class="org-constant">:nothing</span>
<span class="org-keyword">end</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">modify the client.rb file to include the plugin path for the vagrant-ohai plugin</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">At the beginning of every chef-client run, the client.rb file is loaded. </span>
<span class="org-comment-delimiter">#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">@see https://docs.chef.io/config_rb_client.html</span>
<span class="org-comment-delimiter">#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">This ruby_block resource modifies the client.rb to include the '/etc/chef/ohai_plugins'</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">directory, with a guard to check if the file has already been modified.</span>
<span class="org-comment-delimiter">#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">@see https://docs.chef.io/resource_common.html#guards</span>
<span class="org-comment-delimiter">#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">When the client.rb file is modified, the notification adds 'ohai[vagrant-ohai]' to the</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">resource collection, re-running ohai with the new plugin loaded. This ensures we have</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">access to the node['ipaddress'] attribute during this chef-client run.</span>
ruby_block <span class="org-string">"configure ohai plugin path"</span> <span class="org-keyword">do</span>
  block <span class="org-keyword">do</span>
    file = <span class="org-type">Chef</span>::<span class="org-type">Util</span>::<span class="org-type">FileEdit</span>.new(<span class="org-string">"/etc/chef/client.rb"</span>)
    file.insert_line_if_no_match(<span class="org-string">"ohai.plugin_path &lt;&lt; '/etc/chef/ohai_plugins'"</span>,<span class="org-string">"ohai.plugin_path &lt;&lt; '/etc/chef/ohai_plugins'"</span>)
    file.write_file
  <span class="org-keyword">end</span>
  notifies <span class="org-constant">:reload</span>, <span class="org-string">'ohai[vagrant-ipaddress]'</span>, <span class="org-constant">:immediately</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org168ec7f" class="outline-3">
<h3 id="org168ec7f"><span class="section-number-3">10.3</span> Upload Cookbooks</h3>
<div class="outline-text-3" id="text-10-3">
<p>
<code>chef-repo/.chef/</code> directory contains the info needed to communicate with Chef Manage:
</p>

<div class="org-src-container">
<pre class="src src-sh">chef-repo/.chef/
  knife.rb   <span class="org-comment-delimiter"># </span><span class="org-comment">Server URL, cookbook path etc.</span>
  &lt;user&gt;.pem <span class="org-comment-delimiter"># </span><span class="org-comment">Auth credential</span>
</pre>
</div>

<p>
Confirm the local repo can communicate with Chef Manager:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cd chef-repo
$ knife client list
&lt;org&gt;-validator
</pre>
</div>

<p>
Upload cookbooks to Chef Server and confirm the result:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cd chef-repo
$ knife cookbook upload workstation apache <span class="org-comment-delimiter"># </span><span class="org-comment">Don't need to specify the "cookbooks/" directory</span>
Uploaded 2 cookbooks.
$ knife cookbook list
apache        0.1.0
workstation   0.1.0
</pre>
</div>

<p>
Go to <a href="https://api.chef.io">Chef Manage</a> and confirm the cookbooks show up under Policy tab.
</p>
</div>
</div>

<div id="outline-container-orgabd45e4" class="outline-3">
<h3 id="orgabd45e4"><span class="section-number-3">10.4</span> Reconfigure Vagrant Environment</h3>
<div class="outline-text-3" id="text-10-4">
<p>
Start 3 Vagrant nodes of 2 web servers and 1 load balancer with config:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 20: </span><code>chef-repo/Vagrantfile</code></label><pre class="src src-ruby"><span class="org-keyword">unless</span> <span class="org-type">Vagrant</span>.has_plugin?(<span class="org-string">"vagrant-ohai"</span>)
  <span class="org-builtin">raise</span> <span class="org-string">"vagrant-ohai plugin is not installed! Install with 'vagrant plugin install vagrant-ohai'"</span>
<span class="org-keyword">end</span>

<span class="org-type">NODE_SCRIPT</span> = <span class="org-string">&lt;&lt;EOF</span>.freeze
<span class="org-string">  echo "Preparing node..."</span>
<span class="org-string">  # ensure the time is up to date</span>
<span class="org-string">  yum -y install ntp</span>
<span class="org-string">  systemctl start ntpd</span>
<span class="org-string">  systemctl enable ntpd</span>
<span class="org-string">  curl -L https://omnitruck.chef.io/install.sh | sudo bash -s -- -v 14</span>
<span class="org-string">EOF</span>

<span class="org-keyword">def</span> <span class="org-function-name">set_hostname</span>(server)
  server.vm.provision <span class="org-string">'shell'</span>, <span class="org-constant">inline:</span> <span class="org-string">"hostname </span><span class="org-variable-name">#{server.vm.hostname}</span><span class="org-string">"</span>
<span class="org-keyword">end</span>

<span class="org-type">Vagrant</span>.configure(2) <span class="org-keyword">do</span> |config|

  config.vm.define <span class="org-string">'web1'</span> <span class="org-keyword">do</span> |n|
    n.vm.box = <span class="org-string">'bento/centos-7.2'</span>
    n.vm.box_version = <span class="org-string">'2.2.9'</span>
    n.vm.hostname = <span class="org-string">'web1'</span>
    n.vm.network <span class="org-constant">:private_network</span>, <span class="org-constant">ip:</span> <span class="org-string">'192.168.10.43'</span>, <span class="org-constant">nic_type:</span> <span class="org-string">"virtio"</span>
    n.vm.provision <span class="org-constant">:shell</span>, <span class="org-constant">inline:</span> <span class="org-type">NODE_SCRIPT</span>.dup
    set_hostname(n)
  <span class="org-keyword">end</span>

  config.vm.define <span class="org-string">'web2'</span> <span class="org-keyword">do</span> |n|
    n.vm.box = <span class="org-string">'bento/centos-7.2'</span>
    n.vm.box_version = <span class="org-string">'2.2.9'</span>
    n.vm.hostname = <span class="org-string">'web2'</span>
    n.vm.network <span class="org-constant">:private_network</span>, <span class="org-constant">ip:</span> <span class="org-string">'192.168.10.44'</span>, <span class="org-constant">nic_type:</span> <span class="org-string">"virtio"</span>
    n.vm.provision <span class="org-constant">:shell</span>, <span class="org-constant">inline:</span> <span class="org-type">NODE_SCRIPT</span>.dup
    set_hostname(n)
  <span class="org-keyword">end</span>

  config.vm.define <span class="org-string">'load-balancer'</span> <span class="org-keyword">do</span> |n|
    n.vm.box = <span class="org-string">'bento/centos-7.2'</span>
    n.vm.box_version = <span class="org-string">'2.2.9'</span>
    n.vm.hostname = <span class="org-string">'load-balancer'</span>
    n.vm.network <span class="org-string">"forwarded_port"</span>, <span class="org-constant">guest:</span> 80, <span class="org-constant">host:</span> 9000
    n.vm.provision <span class="org-constant">:shell</span>, <span class="org-constant">inline:</span> <span class="org-type">NODE_SCRIPT</span>.dup
    set_hostname(n)
  <span class="org-keyword">end</span>

<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9b2fc83" class="outline-3">
<h3 id="org9b2fc83"><span class="section-number-3">10.5</span> Bootstrap Web Server</h3>
<div class="outline-text-3" id="text-10-5">
<p>
The bootstraping process of a node includes:
</p>

<ul class="org-ul">
<li>Installs Chef Client, if not already installed.</li>
<li>Provides credentials and details of how to communicate with Chef Server.</li>
<li>Runs Ohai.</li>
<li>Converges the node.</li>
<li>Saves the node object to Chef Server.</li>
</ul>

<p>
Get SSH config of the Vagrant nodes:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ vagrant ssh-config
Host web1
  User vagrant
  Port &lt;port&gt; <span class="org-comment-delimiter"># </span><span class="org-comment">To be used in "knife bootstrap" command</span>
  IdentityFile &lt;path_to_id_file&gt; <span class="org-comment-delimiter"># </span><span class="org-comment">To be used in "knife bootstrap" command</span>
</pre>
</div>

<p>
Bootstrap the node with SSH config and confirm the result:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ knife bootstrap localhost <span class="org-string">\ </span><span class="org-comment-delimiter"># </span><span class="org-comment">Because the Vagrant nodes are local</span>
                              <span class="org-comment-delimiter"># </span><span class="org-comment">Will be FQDN or public IP if using cloud provider</span>
-N web1 -p &lt;port&gt; -x vagrant -i &lt;path_to_id_file&gt; --sudo
127.0.0.1 -----&gt; Existing Chef installation detected <span class="org-comment-delimiter"># </span><span class="org-comment">Will install Chef Client if not installed</span>
127.0.0.1 Starting Chef Client, version 14.12.9
127.0.0.1 resolving cookbooks for run list: [] <span class="org-comment-delimiter"># </span><span class="org-comment">There is empty run list</span>
127.0.0.1 Converging 0 resources
$ knife node list
$ knife node show web1
</pre>
</div>

<p>
Add to the node's run list and confirm the result:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ knife node run_list add web1 <span class="org-string">"recipe[workstation],recipe[apache]"</span>
$ knife node show web1
Run List: recipe[workstation], recipe[apache]
</pre>
</div>

<p>
Login to the Vagrant node and run Chef Client:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ vagrant ssh web1
&gt; sudo chef-client <span class="org-comment-delimiter"># </span><span class="org-comment">Don't need additional info, will connect to Chef Server, pull and run recipes</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4ca4e15" class="outline-2">
<h2 id="org4ca4e15"><span class="section-number-2">11</span> Community Cookbooks</h2>
<div class="outline-text-2" id="text-11">
</div><div id="outline-container-org60c6b21" class="outline-3">
<h3 id="org60c6b21"><span class="section-number-3">11.1</span> Explore the Supermarket</h3>
<div class="outline-text-3" id="text-11-1">
<p>
<a href="https://supermarket.chef.io">Chef Supermarket</a> is where the community share Chef cookbooks. There are basically 2 kinds of cookbooks:
</p>

<ul class="org-ul">
<li>Cookbooks of recipes.</li>
<li>Cookbooks of custom resources, e.g. <a href="https://supermarket.chef.io/cookbooks/haproxy">haproxy</a></li>
</ul>

<p>
Cookbooks that provide custom resources can be used as libraries by other cookbooks.
</p>
</div>
</div>

<div id="outline-container-org0c4f026" class="outline-3">
<h3 id="org0c4f026"><span class="section-number-3">11.2</span> Create a Wrapper Cookbook</h3>
<div class="outline-text-3" id="text-11-2">
<p>
A "wrapper cookbook" references other cookbooks as libraries, and use them with custom attributes.
</p>

<p>
Generate a new cookbook:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-builtin">cd</span> chef-repo/cookbooks
chef generate cookbook myhaproxy
</pre>
</div>

<p>
Add <code>haproxy</code> cookbook as dependency:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 21: </span><code>chef-repo/cookbooks/myhaproxy/metadata.rb</code></label><pre class="src src-ruby">depends <span class="org-string">'haproxy'</span>, <span class="org-string">'~&gt; 7.1.0'</span>
</pre>
</div>

<p>
<code>haproxy</code> provides <a href="https://github.com/sous-chefs/haproxy/tree/master/test/fixtures/cookbooks/test/recipes">example recipes</a> to get started with. Copy the recipe <code>config_array.rb</code> to the cookbook (but remove the unneeded parts):
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 22: </span><code>chef-repo/cookbooks/myhaproxy/recipes/default.rb</code></label><pre class="src src-ruby">haproxy_install <span class="org-string">'package'</span>

haproxy_frontend <span class="org-string">'http-in'</span> <span class="org-keyword">do</span>
  bind <span class="org-string">'*:80'</span>
  default_backend <span class="org-string">'servers'</span>
<span class="org-keyword">end</span>

haproxy_backend <span class="org-string">'servers'</span> <span class="org-keyword">do</span>
  server [
    <span class="org-string">'server1 127.0.0.1:8000 maxconn 32'</span> <span class="org-comment-delimiter"># </span><span class="org-comment">IP and port will be updated later</span>
  ]
<span class="org-keyword">end</span>

haproxy_service <span class="org-string">'haproxy'</span> <span class="org-keyword">do</span>
  <span class="org-comment-delimiter"># </span><span class="org-comment">Whenever haproxy_backend is updated, e.g. adding a new node, we need to</span>
  <span class="org-comment-delimiter"># </span><span class="org-comment">reload haproxy service. Subscribe to the template resouce that</span>
  <span class="org-comment-delimiter"># </span><span class="org-comment">haproxy_backend uses and reload whenever it's updated.</span>
  subscribes <span class="org-constant">:reload</span>, <span class="org-string">'template[/etc/haproxy/haproxy.cfg]'</span>, <span class="org-constant">:immediately</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6557567" class="outline-3">
<h3 id="org6557567"><span class="section-number-3">11.3</span> Add Web Server Members</h3>
<div class="outline-text-3" id="text-11-3">
<p>
Confirm node <code>web1</code> IP address:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ knife node show web1
IP: 192.168.10.43 <span class="org-comment-delimiter"># </span><span class="org-comment">As defined in Vagrantfile</span>
</pre>
</div>

<p>
Update IP address in the <code>haproxy</code> recipe:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 23: </span><code>chef-repo/cookbooks/myhaproxy/recipes/default.rb</code></label><pre class="src src-ruby">haproxy_backend <span class="org-string">'servers'</span> <span class="org-keyword">do</span>
  server [
    <span class="org-string">'server1 192.168.10.43:80 maxconn 32'</span>
  ]
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7644e3e" class="outline-3">
<h3 id="org7644e3e"><span class="section-number-3">11.4</span> Manage Cookbooks with Berkshelf</h3>
<div class="outline-text-3" id="text-11-4">
<p>
While a cookbook depends on a community cookbook, the community cookbook may also depends on other cookbooks, in which situation it would be difficult to manage the dependencies. Berkshelf is a dependency manager for Chef cookbooks.
</p>

<p>
Install the dependencies and confirm the result:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cd chef-repo/cookbooks/myhaproxy
$ berks install
$ ls ~/.berkshelf/cookbooks
haproxy-7.1.0 ...
</pre>
</div>

<p>
Upload the dependencies to Chef Server and confirm the result:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ berks upload
$ knife cookbook list
haproxy   7.1.0
...
</pre>
</div>
</div>
</div>

<div id="outline-container-org0a364e9" class="outline-3">
<h3 id="org0a364e9"><span class="section-number-3">11.5</span> Bootstrap Load Balancer</h3>
<div class="outline-text-3" id="text-11-5">
<p>
Similar steps as bootstraping a web server, but the run list can be specified with <code>knife bootstrop</code> command, instead of adding the run list manually and run Chef Client to converge the resources.
</p>

<p>
Get SSH config of the Vagrant nodes:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ vagrant ssh-config
Host load-balancer
  User vagrant
  Port &lt;port&gt; <span class="org-comment-delimiter"># </span><span class="org-comment">To be used in "knife bootstrap" command</span>
  IdentityFile &lt;path_to_id_file&gt; <span class="org-comment-delimiter"># </span><span class="org-comment">To be used in "knife bootstrap" command</span>
</pre>
</div>

<p>
Bootstrap the node with SSH config and run list, and confirm the result:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ knife bootstrap localhost -N load-balancer -p &lt;port&gt; -x vagrant -i &lt;path_to_id_file&gt; -r <span class="org-string">'recipe[myhaproxy]'</span> --sudo
Chef Client finished, 16/29 resources updated ...
$ knife node list
$ knife node show load-balancer
Run List: recipe[myhaproxy]
</pre>
</div>

<p>
Login to the Vagrant node and confirm the load balancer is working:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ vagrant ssh load-balancer
&gt; curl localhost
... <span class="org-comment-delimiter"># </span><span class="org-comment">The HTML output from web server nodes</span>
&gt; sudo service haproxy restart <span class="org-comment-delimiter"># </span><span class="org-comment">Somehow it didn't work in the beginning but restarting the service fixed it</span>
</pre>
</div>

<p>
Confirm the result by browsing to the load balancer's forwarded port <a href="https://http//localhost:9000/">https://http//localhost:9000/</a> from the host machine.
</p>
</div>
</div>
</div>

<div id="outline-container-orgc732050" class="outline-2">
<h2 id="orgc732050"><span class="section-number-2">12</span> Manage Nodes</h2>
<div class="outline-text-2" id="text-12">
</div><div id="outline-container-org57dd0e0" class="outline-3">
<h3 id="org57dd0e0"><span class="section-number-3">12.1</span> Run chef-client on a Schedule</h3>
<div class="outline-text-3" id="text-12-1">
<p>
The community cookbook <a href="https://supermarket.chef.io/cookbooks/chef-client">chef-client</a> can be used to configure the node to run Chef Client periodically.
</p>

<p>
Generate a wrapper cookbook:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-builtin">cd</span> chef-repo
chef generate cookbook cookbooks/mychefclient
</pre>
</div>

<p>
Add <code>chef-client</code> as dependency:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 24: </span><code>chef-repo/cookbooks/mychefclient/metadata.rb</code></label><pre class="src src-ruby">depends <span class="org-string">'chef-client'</span>, <span class="org-string">'~&gt; 11.2.0'</span>
</pre>
</div>

<p>
Update default recipe to run Chef Client periodically:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 25: </span><code>chef-repo/cookbooks/mychefclient/recipes/default.rb</code></label><pre class="src src-ruby">node.default[<span class="org-string">'chef_client'</span>][<span class="org-string">'interval'</span>] = <span class="org-string">'300'</span> <span class="org-comment-delimiter"># </span><span class="org-comment">Run every 300 seconds</span>
node.default[<span class="org-string">'chef_client'</span>][<span class="org-string">'splay'</span>] = <span class="org-string">'60'</span>     <span class="org-comment-delimiter"># </span><span class="org-comment">Random delay of 0-60 seconds before running Chef Client</span>
                                                <span class="org-comment-delimiter"># </span><span class="org-comment">To avoid updating all nodes at the same time</span>

include_recipe <span class="org-string">'chef-client::default'</span>
</pre>
</div>

<p>
Install and upload the dependency:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-builtin">cd</span> chef-repo/cookbooks/mychefclient
berks install
berks upload
</pre>
</div>

<p>
Add the recipe to the run list of the load balancer node, and run Chef Client on it:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-builtin">cd</span> chef-reop
knife node run_list add load-balancer <span class="org-string">'recipe[mychefclient]'</span>
vagrant ssh load-balancer
sudo chef-client
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org2b587d1" class="outline-2">
<h2 id="org2b587d1"><span class="section-number-2">13</span> Roles</h2>
<div class="outline-text-2" id="text-13">
</div><div id="outline-container-orgdadb895" class="outline-3">
<h3 id="orgdadb895"><span class="section-number-3">13.1</span> Create and Assign Roles</h3>
<div class="outline-text-3" id="text-13-1">
<p>
Create a role file:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 26: </span><code>chef-repo/roles/web.rb</code></label><pre class="src src-ruby">name <span class="org-string">'web'</span>
description <span class="org-string">'web server'</span>
run_list <span class="org-string">'recipe[workstation]'</span>,<span class="org-string">'recipe[apache]'</span>
default_attributes <span class="org-string">'apache-test'</span> =&gt; {
  <span class="org-string">'attribute_1'</span> =&gt; <span class="org-string">'this is attribute 1'</span>,
  <span class="org-string">'attribute_2'</span> =&gt; <span class="org-string">'this is attribute 2'</span>
}
</pre>
</div>

<p>
Upload the role to Chef Server:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ knife role from file roles/web.rb
</pre>
</div>

<p>
Set the role to node's run list and apply the role:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ knife node run_list set web1 <span class="org-string">"role[web]"</span>
$ knife node show web1
Run Lists: role[web] <span class="org-comment-delimiter"># </span><span class="org-comment">Role is set to the run list</span>
Roles:               <span class="org-comment-delimiter"># </span><span class="org-comment">No role yet, the role will be converged when Chef Client runs on the node</span>
$ vagrant ssh web1
&gt; sudo chef-client
$ knife node show web1
Run Lists: role[web]
Roles:     web       <span class="org-comment-delimiter"># </span><span class="org-comment">Role is applied</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org74e0017" class="outline-3">
<h3 id="org74e0017"><span class="section-number-3">13.2</span> Converge Using the <code>knife ssh</code> Command</h3>
<div class="outline-text-3" id="text-13-2">
<p>
<code>knife ssh</code> command can be used to SSH connect to the nodes and run commands:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ vagrant ssh-config <span class="org-comment-delimiter"># </span><span class="org-comment">Get the SSH params</span>
User vagrant
Port &lt;port&gt;
IdentityFile &lt;path&gt;
$ knife ssh localhost <span class="org-string">"sudo chef-client"</span> --manual-list -p &lt;port&gt; -x vagrant -i &lt;path&gt;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org995d167" class="outline-2">
<h2 id="org995d167"><span class="section-number-2">14</span> Search</h2>
<div class="outline-text-2" id="text-14">
</div><div id="outline-container-org5d9a0a5" class="outline-3">
<h3 id="org5d9a0a5"><span class="section-number-3">14.1</span> Explore Chef Server Indices</h3>
<div class="outline-text-3" id="text-14-1">
<p>
Chef Server maintains (in a PostgreSQL database) a searchable index of all nodes with the infrastructure. <code>knife search</code> command can be used to search through these indices.
</p>
</div>
</div>

<div id="outline-container-orgd785c4b" class="outline-3">
<h3 id="orgd785c4b"><span class="section-number-3">14.2</span> Run Searches with Knife</h3>
<div class="outline-text-3" id="text-14-2">
<div class="org-src-container">
<pre class="src src-sh">$ knife search node <span class="org-string">"*:*"</span>         <span class="org-comment-delimiter"># </span><span class="org-comment">All nodes</span>
$ knife search node <span class="org-string">"name:*"</span>      <span class="org-comment-delimiter"># </span><span class="org-comment">Nodes with any name</span>
$ knife search node <span class="org-string">"name:web?"</span>   <span class="org-comment-delimiter"># </span><span class="org-comment">Nodes with names of "web" followed by a character</span>
$ knife search node <span class="org-string">"*:*"</span> -a name <span class="org-comment-delimiter"># </span><span class="org-comment">Names of all nodes</span>
$ knife search node <span class="org-string">"role:web AND recipes:apache"</span> <span class="org-comment-delimiter"># </span><span class="org-comment">Nodes with role "web" and recipe "apache"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdb57a47" class="outline-3">
<h3 id="orgdb57a47"><span class="section-number-3">14.3</span> Refactor for Dynamic Load Balancing</h3>
<div class="outline-text-3" id="text-14-3">
<p>
Previously the <code>haproxy</code> load balancer was configures with hard-coded web nodes. By using Chef Server's search indices, the load balancer can be configures to query and update the web nodes automatically.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 27: </span><code>chef-repo/cookbooks/myhaproxy/recipes/default.rb</code></label><pre class="src src-ruby"><span class="org-comment-delimiter"># </span><span class="org-comment">The hard-coded server list</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">haproxy_backend 'servers' do</span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">server [</span>
<span class="org-comment-delimiter">#     </span><span class="org-comment">'server1 192.168.10.43:80 maxconn 32',</span>
<span class="org-comment-delimiter">#     </span><span class="org-comment">'server2 192.168.10.44:80 maxconn 32',</span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">]</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">end</span>

web_nodes = search(<span class="org-string">'node'</span>, <span class="org-string">'role:web'</span>) <span class="org-comment-delimiter"># </span><span class="org-comment">Returns the same result as "knife search" command</span>
servers = []

web_nodes.each <span class="org-keyword">do</span> |web_node|
  server = <span class="org-string">"</span><span class="org-variable-name">#{web_node['hostname']}</span><span class="org-string"> </span><span class="org-variable-name">#{web_node['ipaddress']}</span><span class="org-string">:80 maxconn 32"</span>
  servers.push(server)
<span class="org-keyword">end</span>

haproxy_backend <span class="org-string">'servers'</span> <span class="org-keyword">do</span>
  server servers
<span class="org-keyword">end</span>
</pre>
</div>

<p>
If the infrastructure is hosted on a cloud provider, the host name and IP attributes to use will be different, namely <code>node['cloud']['public_hostname']</code> and <code>node['cloud']['public_ipv4']</code>.
</p>
</div>
</div>
</div>

<div id="outline-container-orgeb976e0" class="outline-2">
<h2 id="orgeb976e0"><span class="section-number-2">15</span> Environments</h2>
<div class="outline-text-2" id="text-15">
</div><div id="outline-container-org0331aef" class="outline-3">
<h3 id="org0331aef"><span class="section-number-3">15.1</span> Create and Manage a Production Environment</h3>
<div class="outline-text-3" id="text-15-1">
<p>
All nodes belong to the <code>_default</code> environment by default:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ knife search node <span class="org-string">'*:*'</span>
Environment: _default
</pre>
</div>

<p>
Create a new environment file:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 28: </span><code>chef-repo/environments/production.rb</code></label><pre class="src src-ruby">name <span class="org-string">'production'</span>
description <span class="org-string">'Production environment'</span>
cookbook <span class="org-string">'apache'</span>, <span class="org-string">'= 0.1.1'</span> <span class="org-comment-delimiter"># </span><span class="org-comment">To match the actual current version of the cookbook</span>
cookbook <span class="org-string">'myhaproxy'</span>, <span class="org-string">'= 0.2.0'</span> <span class="org-comment-delimiter"># </span><span class="org-comment">To match the actual current version of the cookbook</span>
</pre>
</div>

<p>
Upload the environment to Chef Server, and confirm the result:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ knife environment from file environments/production.rb
$ knife environment list
$ knife environment show production
</pre>
</div>

<p>
Set one node to production environment, and confirm the result:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ knife node environment set web1 production
$ knife node show web1
</pre>
</div>

<p>
By setting the node to the environment, only Chef Server knows about it, the node itself won't be aware of the change until Chef Client runs on the node. 
</p>
</div>
</div>

<div id="outline-container-org77751c4" class="outline-3">
<h3 id="org77751c4"><span class="section-number-3">15.2</span> Refine the Load Balancer</h3>
<div class="outline-text-3" id="text-15-2">
<p>
The load balancer cookbook needs to be updated to avoid routing traffic to web nodes of different environments:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 29: </span><code>chef-repo/cookbooks/myhaproxy/recipes/default.rb</code></label><pre class="src src-ruby">web_nodes = search(<span class="org-string">'node'</span>, <span class="org-string">'role:web'</span>)
<span class="org-comment-delimiter"># </span><span class="org-comment">Update to:</span>
web_nodes = search(<span class="org-string">'node'</span>, <span class="org-string">"role:web AND chef_environment:</span><span class="org-variable-name">#{node.chef_environment}</span><span class="org-string">"</span>)
</pre>
</div>

<p>
Note that after incrementing <code>myhaproxy</code> cookbook's version following the above change, the cookbook version restrictions of the load balancer node's environment need to be updated too, otherwise this latest version of cookbook won't be used on the node.
</p>
</div>
</div>
</div>

<div id="outline-container-org3d6d03c" class="outline-2">
<h2 id="org3d6d03c"><span class="section-number-2">16</span> Data Bags</h2>
<div class="outline-text-2" id="text-16">
</div><div id="outline-container-orgbffba4a" class="outline-3">
<h3 id="orgbffba4a"><span class="section-number-3">16.1</span> What's in the Bag?</h3>
<div class="outline-text-3" id="text-16-1">
<p>
A data bag is a collection of data that is relevant to and can be accessed by multiple nodes, such as user accounts and passwords, to avoid duplicating these info for each node.
</p>
</div>
</div>

<div id="outline-container-org1f89857" class="outline-3">
<h3 id="org1f89857"><span class="section-number-3">16.2</span> Create and Manage Data Bags</h3>
<div class="outline-text-3" id="text-16-2">
<p>
Create data bags for users and groups data, and confirm the result:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ knife data bag create users
$ knife data bag create groups
$ knife data bag list
</pre>
</div>

<p>
Create JSON files for data bag items:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 30: </span><code>chef-repo/databags/users/user1.json</code></label><pre class="src src-js">{
  <span class="org-string">"id"</span>: <span class="org-string">"user1"</span>,
  <span class="org-string">"comment"</span>: <span class="org-string">"This is user 1"</span>,
  <span class="org-string">"uid"</span>: <span class="org-string">"100"</span>,
  <span class="org-string">"gid"</span>: <span class="org-string">"1"</span>,
  <span class="org-string">"home"</span>: <span class="org-string">"/home/user1"</span>,
  <span class="org-string">"shell"</span>: <span class="org-string">"/bin/bash"</span>,
  <span class="org-string">"platform"</span>: <span class="org-string">"centos"</span>
}
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 31: </span><code>chef-repo/databags/groups/group1.json</code></label><pre class="src src-js">{
  <span class="org-string">"id"</span>: <span class="org-string">"group1"</span>,
  <span class="org-string">"gid"</span>: <span class="org-string">"1"</span>,
  <span class="org-string">"members"</span>: [<span class="org-string">"user1"</span>]
}
</pre>
</div>

<p>
Add the items to the data bag, and confirm the result:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ knife data bag from file users databags/users/user1.json
$ knife data bag from file groups databags/groups/group1.json
$ knife data bag show users
$ knife data bag show groups
</pre>
</div>

<p>
Data bags are indexed by Chef, so it's available for search:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ knife search users <span class="org-string">"*:*"</span>
$ knife search users <span class="org-string">"platform:centos"</span>
$ knife search users <span class="org-string">"platform:centos"</span> -a comment
</pre>
</div>
</div>
</div>

<div id="outline-container-org7ea1ee5" class="outline-3">
<h3 id="org7ea1ee5"><span class="section-number-3">16.3</span> Dynamic Search and Find</h3>
<div class="outline-text-3" id="text-16-3">
<p>
Create a cookbook to use the data bag to create users:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ chef generate cookbook cookbooks/users
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 32: </span><code>chef-repo/cookbooks/users/recipes/default.rb</code></label><pre class="src src-ruby">search(<span class="org-string">'users'</span>, <span class="org-string">'platform:centos'</span>).each <span class="org-keyword">do</span> |user_data|
  user user_data[<span class="org-string">'id'</span>] <span class="org-keyword">do</span>
    comment user_data[<span class="org-string">'comment'</span>]
    uid user_data[<span class="org-string">'uid'</span>]
    gid user_data[<span class="org-string">'gid'</span>]
    home user_data[<span class="org-string">'home'</span>]
    shell user_data[<span class="org-string">'shell'</span>]
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
Update the role file:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 33: </span><code>chef-repo/roles/web.rb</code></label><pre class="src src-ruby">run_list <span class="org-string">'recipe[users]'</span>,<span class="org-string">'recipe[workstation]'</span>,<span class="org-string">'recipe[apache]'</span>
</pre>
</div>

<p>
Upload the cookbook and update the role on Chef Server:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ knife cookbook upload users
$ knife role from file roles/web.rb
</pre>
</div>

<p>
Converge the web node and confirm the user is created by Chef:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ vagrant ssh web1
&gt; sudo chef-client
&gt; grep <span class="org-string">"user1"</span> /etc/passwd
user1:x:1001:1001::/home/user1:/bin/bash
</pre>
</div>
</div>
</div>

<div id="outline-container-org56e461f" class="outline-3">
<h3 id="org56e461f"><span class="section-number-3">16.4</span> Encrypt Secrets</h3>
<div class="outline-text-3" id="text-16-4">
<p>
Data bags can be encrypted to protected sensitive information such as passwords. Create a secret key and an encrypted data bag, and upload an encrypted data bag item to it:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ openssl rand -base64 512 &gt; secret_key
$ knife data bag create secret_users --secret-file secret_key
$ knife data bag from file secret_users databags/users/user1.json --secret-file secret_key
</pre>
</div>

<p>
Confirm the data bag item is encrypted, and can be decrypted by using the secret key:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ knife data bag show secret_users user1
<span class="org-comment-delimiter"># </span><span class="org-comment">Encrypted data</span>
$ knife data bag show secret_users user1 --secret-file secret_key
<span class="org-comment-delimiter"># </span><span class="org-comment">Decrypted data</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Victor Chen</p>
<p class="date">Created: 2019-06-16 Sun 19:39</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
