---
title: "Linux Scrap"
---
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-11-23 Sat 20:51 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux Scrap</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Victor Chen" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="../../styles/readtheorg/css/font.css"/>
<link rel="stylesheet" type="text/css" href="../../styles/readtheorg/css/readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="../../styles/readtheorg/css/htmlize.css"/>
<script type="text/javascript" src="../../styles/readtheorg/js/jquery.min.js"></script>
<script type="text/javascript" src="../../styles/readtheorg/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Linux Scrap</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org27e4dc5">1 Linux 服务器初步配置</a>
<ul>
<li><a href="#org5a595f7">1.1 登录</a></li>
<li><a href="#org481ffc2">1.2 添加用户</a></li>
<li><a href="#org0f5d514">1.3 SSH</a></li>
<li><a href="#orgc9aa5f6">1.4 运行环境</a></li>
<li><a href="#org64a545d">1.5 安全</a></li>
</ul>
</li>
<li><a href="#orgc26255c">2 Linux 启动流程</a>
<ul>
<li><a href="#org5f80341">2.1 加载内核</a></li>
<li><a href="#org9a2e91e">2.2 初始化进程</a></li>
<li><a href="#org82e187c">2.3 运行级别</a></li>
<li><a href="#orgc1fb617">2.4 开机启动程序</a></li>
<li><a href="#orgdacac86">2.5 用户登录</a></li>
<li><a href="#org9043822">2.6 Login shell</a></li>
<li><a href="#orgc1c4c29">2.7 Non-login shell</a></li>
<li><a href="#orgb83f749">2.8 链接</a></li>
</ul>
</li>
<li><a href="#orgc5c195a">3 inode 入门</a>
<ul>
<li><a href="#orgee16733">3.1 inode 是什么？</a></li>
<li><a href="#org873eec6">3.2 inode 内容</a></li>
<li><a href="#orge3690a6">3.3 inode 大小</a></li>
<li><a href="#org95a879e">3.4 inode 编号</a></li>
<li><a href="#org7e527e0">3.5 目录文件</a></li>
<li><a href="#org7dcccbc">3.6 硬链接</a></li>
<li><a href="#org90b7131">3.7 软链接</a></li>
<li><a href="#org7aa0075">3.8 inode 的特殊作用</a></li>
</ul>
</li>
<li><a href="#org2d60306">4 systemd 入门（未完成）</a>
<ul>
<li><a href="#orgdffd73a">4.1 历史</a></li>
<li><a href="#org0516759">4.2 概述</a></li>
<li><a href="#org362f025">4.3 系统管理命令</a>
<ul>
<li><a href="#orgc722767">4.3.1 <code>systemctl</code></a></li>
<li><a href="#org392a8bd">4.3.2 <code>systemd-analyze</code></a></li>
<li><a href="#orgde9d776">4.3.3 <code>hostnamectl</code></a></li>
<li><a href="#org5e1e67d">4.3.4 <code>localectl</code></a></li>
<li><a href="#orge801fb2">4.3.5 <code>timedatectl</code></a></li>
<li><a href="#org099a24c">4.3.6 <code>loginctl</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org2ca3c5c">5 Unix 目录结构的来历</a></li>
<li><a href="#orgf4c2d65">6 Linux 系统负荷</a>
<ul>
<li><a href="#org5dd1525">6.1 查看系统负荷</a></li>
<li><a href="#org692ad80">6.2 一个类比</a></li>
<li><a href="#org96d4f9c">6.3 系统负荷的经验法则</a></li>
<li><a href="#orgcfc6e84">6.4 多处理器</a></li>
<li><a href="#orgc8783ea">6.5 多核处理器</a></li>
<li><a href="#orgdcac93d">6.6 最佳观察时长</a></li>
</ul>
</li>
<li><a href="#org0d7c8ba">7 用户态与内核态</a>
<ul>
<li><a href="#org63940ea">7.1 链接</a></li>
</ul>
</li>
<li><a href="#org43a8b56">8 Unix 版权史</a></li>
<li><a href="#orgc5b5353">9 5 simple ways to troubleshoot using Strace</a>
<ul>
<li><a href="#org1d8df5a">9.1 What is strace?</a></li>
<li><a href="#org1b1d67e">9.2 Find out which config files a program reads on startup</a></li>
<li><a href="#org09963ed">9.3 Why does this program not open my file?</a></li>
<li><a href="#orgd82a755">9.4 What is that process doing right now?</a></li>
<li><a href="#org5059695">9.5 What is taking time?</a></li>
<li><a href="#orgd419ac0">9.6 Why can't I connect to that server?</a></li>
</ul>
</li>
<li><a href="#orgc992505">10 How to find out if a system uses SysV, Upstart or Systemd</a></li>
<li><a href="#orgd0afe53">11 Shared Libraries: Understanding Dynamic Loading</a>
<ul>
<li><a href="#org2f8cc35">11.1 Shared Library</a></li>
<li><a href="#orge2ad3f7">11.2 Example Setup</a></li>
<li><a href="#org6e7c9f7">11.3 Compiling Shared Library</a></li>
<li><a href="#org7106ce2">11.4 Compiling and Linking Dynamic Executable</a></li>
<li><a href="#org0474ee2">11.5 ELF (Executable and Linkable Format)</a></li>
<li><a href="#orgbed384e">11.6 Direct Dependency</a></li>
<li><a href="#org6db8fac">11.7 Runtime Search Path</a></li>
<li><a href="#orgc8709db">11.8 Fixing Dependency</a></li>
<li><a href="#org5060dfd">11.9 <code>rpath</code> and <code>runpath</code></a></li>
<li><a href="#orgda08b54">11.10 <code>$ORIGIN</code></a></li>
<li><a href="#org9c5bdf5">11.11 Runtime Search Path Security</a></li>
<li><a href="#org6e2c1b4">11.12 Debugging Cheat Sheet</a></li>
<li><a href="#org06e5f3a">11.13 Links</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org27e4dc5" class="outline-2">
<h2 id="org27e4dc5"><span class="section-number-2">1</span> Linux 服务器初步配置</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="http://www.ruanyifeng.com/blog/2014/03/server_setup.html">Source</a>
</p>
</div>

<div id="outline-container-org5a595f7" class="outline-3">
<h3 id="org5a595f7"><span class="section-number-3">1.1</span> 登录</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>使用 <code>root</code> 用户登录远程主机</label><pre class="src src-sh">$ ssh root@128.199.209.242
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>修改 <code>root</code> 用户密码</label><pre class="src src-sh">$ passwd
</pre>
</div>
</div>
</div>

<div id="outline-container-org481ffc2" class="outline-3">
<h3 id="org481ffc2"><span class="section-number-3">1.2</span> 添加用户</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>添加用户组</label><pre class="src src-sh">$ addgroup admin
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>添加用户</label><pre class="src src-sh">$ useradd -d /home/foo -s /bin/bash -m foo
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>设置密码</label><pre class="src src-sh">$ passwd foo
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>将用户添加到组</label><pre class="src src-sh">$ usermod -a -G admin foo
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>设置 sudo 权限</label><pre class="src src-sh">$ visudo

foo    <span class="org-variable-name">ALL</span>=(ALL:ALL) ALL
foo    <span class="org-variable-name">ALL</span>=(ALL) NOPASSWD: ALL <span class="org-comment-delimiter"># </span><span class="org-comment">sudo &#26102;&#19981;&#38656;&#35201;&#36755;&#20837;&#23494;&#30721;&#65292;&#19981;&#23433;&#20840;</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>退出 <code>root</code> 用户登录，用新用户身份登录</label><pre class="src src-sh">$ exit
$ ssh foo@128.199.209.242
</pre>
</div>
</div>
</div>

<div id="outline-container-org0f5d514" class="outline-3">
<h3 id="org0f5d514"><span class="section-number-3">1.3</span> SSH</h3>
<div class="outline-text-3" id="text-1-3">
<p>
首先，确定本地有 SSH 公钥，一般是 <code>~/.ssh/id_rsa.pub</code> ，如果没有的话，使用 <code>ssh-keygen</code> 命令生成一个。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>将本地的公钥拷贝到服务器的 <code>authorized_keys</code> 文件</label><pre class="src src-sh">$ cat ~/.ssh/id_rsa.pub | ssh foo@128.199.209.242 <span class="org-string">'mkdir -p .ssh &amp;&amp; cat - &gt;&gt; ~/.ssh/authorized_keys'</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>或者在服务器端直接写入文件</label><pre class="src src-sh">$ echo <span class="org-string">"ssh-rsa &lt;public key&gt;"</span> &gt; ~/.ssh/authorized_keys
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>修改 <code>authorized_keys</code> 文件权限</label><pre class="src src-sh">$ sudo chmod 600 ~/.ssh/authorized_keys &amp;&amp; chmod 700 ~/.ssh/
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>修改 SSH 配置文件 <code>/etc/ssh/sshd_config</code></label><pre class="src src-sh">$ sudo cp /etc/ssh/sshd_config ~
$ sudo nano /etc/ssh/sshd_config

Port 25000                <span class="org-comment-delimiter"># </span><span class="org-comment">&#20462;&#25913;&#40664;&#35748;&#31471;&#21475;</span>
Protocol 2

PermitRootLogin no        <span class="org-comment-delimiter"># </span><span class="org-comment">&#31105;&#27490; root &#29992;&#25143;&#30331;&#24405;</span>
PermitEmptyPasswords no
PasswordAuthentication no <span class="org-comment-delimiter"># </span><span class="org-comment">&#31105;&#27490;&#23494;&#30721;&#26041;&#24335;&#30331;&#24405;</span>

RSAAuthentication yes
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys

UseDNS no

AllowUsers foo            <span class="org-comment-delimiter"># </span><span class="org-comment">&#25351;&#23450;&#20801;&#35768;&#30331;&#24405;&#30340;&#29992;&#25143;</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 13: </span>重启 sshd</label><pre class="src src-sh">$ sudo service ssh restart
<span class="org-comment-delimiter"># </span><span class="org-comment">&#25110;</span>
$ sudo /etc/init.d/ssh restart
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 14: </span>（可选）在本地创建 SSH 连接配置文件 <code>~/.ssh/config</code></label><pre class="src src-sh">Host h1
HostName 128.199.209.242
User foo
Port 25000
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 15: </span>测试 SSH 连接</label><pre class="src src-sh">$ ssh h1
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc9aa5f6" class="outline-3">
<h3 id="orgc9aa5f6"><span class="section-number-3">1.4</span> 运行环境</h3>
<div class="outline-text-3" id="text-1-4">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 16: </span>检查区域设置</label><pre class="src src-sh">$ locale
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 17: </span>如果不是 <code>en_US.UTF-8</code> ，建议修改</label><pre class="src src-sh">$ sudo locale-gen en_US en_US.UTF-8 en_CA.UTF-8
$ sudo dpkg-reconfigure locales
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 18: </span>更新软件</label><pre class="src src-sh">$ sudo apt-get update
$ sudo apt-get upgrade
</pre>
</div>
</div>
</div>

<div id="outline-container-org64a545d" class="outline-3">
<h3 id="org64a545d"><span class="section-number-3">1.5</span> 安全</h3>
<div class="outline-text-3" id="text-1-5">
<p>
根据需要进行安全设置，比如搭建防火墙，关闭 HTTP、HTTPs、SSH 以外的端口，安装 Fail2Ban，可参考 <a href="http://spenserj.com/blog/2013/07/15/securing-a-linux-server/">Securing a Linux Server</a>。
</p>
</div>
</div>
</div>

<div id="outline-container-orgc26255c" class="outline-2">
<h2 id="orgc26255c"><span class="section-number-2">2</span> Linux 启动流程</h2>
<div class="outline-text-2" id="text-2">
<p>
<a href="http://www.ruanyifeng.com/blog/2013/08/linux_boot_process.html">Source</a>
</p>

<p>
计算机的启动在 BIOS 和主引导记录阶段涉及操作系统，只与主板的板载程序有关。在 BIOS 阶段，计算机的行为基本上被写死了，程序员可以做的事情并不多。但是，一旦进入操作系统，程序员几乎可以定制所有方面。下面以 Debian 为例，介绍操作系统接管硬件以后的启动流程。
</p>
</div>

<div id="outline-container-org5f80341" class="outline-3">
<h3 id="org5f80341"><span class="section-number-3">2.1</span> 加载内核</h3>
<div class="outline-text-3" id="text-2-1">
<p>
操作系统接管硬件以后，首先读入 <code>/boot</code> 目录下的内核文件。
</p>
</div>
</div>

<div id="outline-container-org9a2e91e" class="outline-3">
<h3 id="org9a2e91e"><span class="section-number-3">2.2</span> 初始化进程</h3>
<div class="outline-text-3" id="text-2-2">
<p>
内核文件加载以后，就运行第一个程序 <span class="underline"><code>/sbin/init</code> ，初始化系统环境。init 是第一个运行的程序，进程编号（pid）是 1，其他所有进程都是它的子进程。</span>
</p>
</div>
</div>

<div id="outline-container-org82e187c" class="outline-3">
<h3 id="org82e187c"><span class="section-number-3">2.3</span> 运行级别</h3>
<div class="outline-text-3" id="text-2-3">
<p>
许多程序需要开机启动，它们在 Windows 叫做「服务」（service），在 Linux 叫做「守护进程」（daemon）。
</p>

<p>
<span class="underline">init 进程的一大任务，就是运行开机启动的程序。</span> 但是，不同的场合需要启动不同的程序，比如用作服务器时，需要启动 Apache，用作桌面就不需要。Linux 允许 <span class="underline">为不同的场合，分配不同的开机启动程序，叫做「运行级别」（run-level）。</span> 也就是说，启动时根据运行级别，确定要运行哪些程序。Linux <span class="underline">预置 7 种运行级别（0~6）</span> 。一般来说：
</p>

<ul class="org-ul">
<li>0：关机</li>
<li>1：单用户模式（维护模式）</li>
<li>2 ~ 5：多用户模式（正常模式）</li>
<li>6：重启</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 19: </span>init 进程首先读取 <span class="underline">运行级别的设置文件 <code>/etc/inittab</code></span> 第一行：</label><pre class="src src-sh">id:2:initdefault: <span class="org-comment-delimiter"># </span><span class="org-comment">&#31995;&#32479;&#21551;&#21160;&#26102;&#30340;&#40664;&#35748;&#36816;&#34892;&#32423;&#21035;&#20026; 2</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 20: </span><span class="underline">每个运行级别在 <code>/etc</code> 目录下有对应的子目录，指定要加载的程序</span> ：</label><pre class="src src-sh">/etc/rc0.d <span class="org-comment-delimiter"># </span><span class="org-comment">rc = run command, d = directory</span>
/etc/rc1.d
/etc/rc2.d
/etc/rc3.d
/etc/rc4.d
/etc/rc5.d
/etc/rc6.d
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 21: </span>查看 <code>/etc/rc2.d</code> 下指定的程序：</label><pre class="src src-sh">$ ls  /etc/rc2.d

README
S01motd
S13rpcbind
S14nfs-common
S16binfmt-support
S16rsyslog
S16sudo
S17apache2
S18acpid
...
</pre>
</div>

<p>
除了 <code>README</code> 以外，其他文件名都是「S + 两位数字 + 程序名」的形式。字母 S 表示启动脚本的运行参数为 <code>start</code> ，如果这个位置是字母 K，就代表 <code>kill</code> ，即如果从其他运行级别切换过来，需要关闭的程序（启动脚本的运行参数为 <code>stop</code> ）。后面的两位数字表示处理顺序，数字越小越早处理，所以第一个启动的程序是 motd，然后是 rpcbing、nfs 等。数字相同时，则按照程序名的字母顺序启动，所以 rsyslog 会先于 sudo 启动。
</p>

<p>
这个目录里的所有文件（除了 <code>README</code> ）就是启动时要加载的程序。如果想增加或删除某些程序，不建议手动修改 <code>/etc/rc*.d</code> 目录，最好用专门命令进行管理（参考 <a href="http://www.debianadmin.com/manage-linux-init-or-startup-scripts.html">Manage Linux init or startup scripts</a> 和 <a href="http://www.debianadmin.com/remove-unwanted-startup-files-or-services-in-debian.html">Remove Unwanted Startup Files or Services</a>）。
</p>
</div>
</div>

<div id="outline-container-orgc1fb617" class="outline-3">
<h3 id="orgc1fb617"><span class="section-number-3">2.4</span> 开机启动程序</h3>
<div class="outline-text-3" id="text-2-4">
<p>
如果多个运行级别需要启动同一个程序，那么这个程序的启动脚本，就会在每一个运行级别的目录里都有一个拷贝。这样会造成管理上的困扰：如果要修改启动脚本，岂不是每个目录都要改一遍？Linux 的解决办法是 7 个 <span class="underline"><code>/etc/rc*.d</code> 目录里列出的程序都是链接文件，真正的启动脚本统一放在 <code>/etc/init.d</code> 目录下。</span> init 进程逐一加载开机启动程序，其实是运行这个目录里的启动脚本。
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ls -l /etc/rc2.d

README
S01motd -&gt; ../init.d/motd
S13rpcbind -&gt; ../init.d/rpcbind
S14nfs-common -&gt; ../init.d/nfs-common
S16binfmt-support -&gt; ../init.d/binfmt-support
S16rsyslog -&gt; ../init.d/rsyslog
S16sudo -&gt; ../init.d/sudo
S17apache2 -&gt; ../init.d/apache2
S18acpid -&gt; ../init.d/acpid
...
</pre>
</div>

<p>
这样做的另一个好处，就是如果要 <span class="underline">手动关闭或重启某个进程，直接到目录 <code>/etc/init.d</code> 中寻找启动脚本</span> 即可。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 22: </span>比如，重启 Apache 服务器：</label><pre class="src src-sh">$ sudo /etc/init.d/apache2 restart
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdacac86" class="outline-3">
<h3 id="orgdacac86"><span class="section-number-3">2.5</span> 用户登录</h3>
<div class="outline-text-3" id="text-2-5">
<p>
一般来说，用户的登录方式有三种：
</p>

<ul class="org-ul">
<li>命令行登录</li>
<li>SSH 登录</li>
<li>图形界面登录</li>
</ul>

<p>
这三种情况，都有自己的方式对用户进行认证。
</p>

<ul class="org-ul">
<li>命令行登录：init 进程调用 getty（get teletype），让用户输入用户名和密码。输入完成后，再调用 login 程序，核对密码（Debian 还会再多运行一个身份核对程序 <code>/etc/pam.d/login</code> ）。如果密码正确，就从文件 <code>/etc/passwd</code> 读取该用户指定的 shell，然后启动 shell。</li>
<li>SSH 登录：这时系统调用 sshd （Debian 还会再运行 <code>/etc/pam.d/ssh</code> ），取代 getty 和 login ，然后启动 shell。</li>
<li>图形界面登录：init 进程调用显示管理器，Gnome 图形界面对应的显示管理器为 gdm（GNOME Display Manager），然后用户输入用户名和密码。如果密码正确，就读取 <code>/etc/gdm3/Xsession</code> ，启动用户的会话。</li>
</ul>
</div>
</div>

<div id="outline-container-org9043822" class="outline-3">
<h3 id="org9043822"><span class="section-number-3">2.6</span> Login shell</h3>
<div class="outline-text-3" id="text-2-6">
<p>
所谓 shell，简单说就是命令行界面，让用户可以直接与操作系统对话。用户登录时打开的 shell，就叫做 login shell。Debian 默认的 shell 是 Bash，它会读入一系列的配置文件。上一步的三种情况，在这一步的处理，也存在差异。
</p>

<ul class="org-ul">
<li>命令行登录：首先读入 <span class="underline"><code>/etc/profile</code> ，这是对所有用户都有效的配置；然后依次寻找三个针对当前用户的配置，</span> 这三个文件只要有一个存在，就不再读入后面的文件了：</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">~/.bash_profile
~/.bash_login
~/.profile
</pre>
</div>

<ul class="org-ul">
<li>SSH 登录：同上。</li>
<li>图形界面登录：只加载 <code>/etc/profile</code> 和 <code>~/.profile</code> 。</li>
</ul>
</div>
</div>

<div id="outline-container-orgc1c4c29" class="outline-3">
<h3 id="orgc1c4c29"><span class="section-number-3">2.7</span> Non-login shell</h3>
<div class="outline-text-3" id="text-2-7">
<p>
上一步完成以后，Linux 的启动过程就算结束了，用户已经可以看到命令行提示符或者图形界面了。用户进入操作系统以后，常常会再手动开启一个 shell，叫做 non-login shell，意思是它不同于登录时出现的那个 shell，不读取 <code>/etc/profile</code> 和 <code>~/.profile</code> 等配置文件，而是 <span class="underline">读取用户的 bash 配置文件 <code>~/.bashrc</code></span> 。大多数时候，对于 bash 的定制，都是写在这个文件里面的。
</p>

<p>
如果不进入 non-login shell，岂不是 <code>~/.bashrc</code> 就不会运行，因此 bash 也就不能完成定制了？Debian 已经考虑到这个问题了， <code>~/.profile</code> 可以看到下面的代码：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-keyword">if</span> [ -n <span class="org-string">"$BASH_VERSION"</span> ]; <span class="org-keyword">then</span>
    <span class="org-keyword">if</span> [ -f <span class="org-string">"$HOME/.bashrc"</span> ]; <span class="org-keyword">then</span>
        . <span class="org-string">"$HOME/.bashrc"</span>
    <span class="org-keyword">fi</span>
<span class="org-keyword">fi</span>
</pre>
</div>

<p>
先判断变量 <code>$BASH_VERSION</code> 是否有值，然后判断主目录下是否存在 <code>.bashrc</code> 文件，如果存在就运行该文件。第三行开头的 <code>.</code> 是 <code>source</code> 命令的简写形式，表示运行某个文件，即 <code>source ~/.bashrc</code> 。因此，只要运行 <code>~/.profile</code> ， <code>~/.bashrc</code> 就会连带运行。但是上面提到过，如果存在 <code>~/.bash_profile</code> ，那么有可能不会运行 <code>~/.profile</code> 。解决这个问题很简单，把下面代码写入 <code>.bash_profile</code> 就行了。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-keyword">if</span> [ -f ~/.profile ]; <span class="org-keyword">then</span>
    . ~/.profile
<span class="org-keyword">fi</span>
</pre>
</div>

<p>
这样一来，不管是哪种情况， <code>~/.bashrc</code> 都会执行，用户的设置可以放心地都写入这个文件。
</p>

<p>
Bash 的设置如此繁琐，是历史原因造成的。早期计算机运行速度很慢，载入配置文件需要很长时间，Bash 的作者只好把配置文件分成几个部分，阶段性载入。系统的通用设置放在 <code>/etc/profile</code> ，用户个人的、需要被所有子进程继承的设置放在 <code>~/.profile</code> ，不需要被继承的设置放在 <code>~/.bashrc</code> 。
</p>
</div>
</div>

<div id="outline-container-orgb83f749" class="outline-3">
<h3 id="orgb83f749"><span class="section-number-3">2.8</span> 链接</h3>
<div class="outline-text-3" id="text-2-8">
<ol class="org-ol">
<li><a href="https://wiki.debian.org/EnvironmentVariables">Debian Wiki: Environment Variables</a></li>
<li><a href="https://wiki.debian.org/DotFiles">Debian Wiki: Dot Files</a></li>
<li><a href="http://www.debian-administration.org/articles/212">Debian Administration: An introduction to run-levels</a></li>
<li><a href="http://www.debianadmin.com/debian-and-ubuntu-linux-run-levels.html">Debian Admin: Debian and Ubuntu Linux Run Levels</a></li>
<li><a href="http://www.linfo.org/runlevel_def.html">Runlevel Definition</a></li>
<li><a href="http://wiki.linuxquestions.org/wiki/Run_Levels">What are run levels?</a></li>
<li><a href="http://dghubble.com/.bashprofile-.profile-and-.bashrc-conventions.html">Bash Configurations Demystified</a></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgc5c195a" class="outline-2">
<h2 id="orgc5c195a"><span class="section-number-2">3</span> inode 入门</h2>
<div class="outline-text-2" id="text-3">
<p>
<a href="http://www.ruanyifeng.com/blog/2011/12/inode.html">Source</a>
</p>

<p>
inode 是一个重要概念，是理解 Unix/Linux 文件系统和硬盘储存的基础。理解 inode，不仅有助于提高系统操作水平，还有助于体会 Unix 设计哲学，即如何把底层的复杂性抽象成一个简单概念，从而大大简化用户接口。
</p>
</div>

<div id="outline-container-orgee16733" class="outline-3">
<h3 id="orgee16733"><span class="section-number-3">3.1</span> inode 是什么？</h3>
<div class="outline-text-3" id="text-3-1">
<p>
文件储存在硬盘上，硬盘的最小存储单位叫做「扇区」（sector）。每个扇区储存 512 字节。
</p>

<p>
操作系统读取硬盘的时候，不会一个个扇区地读取，而是一次性连续读取多个扇区，即一次性读取一个「块」（block）。由多个扇区组成的「块」，是文件存取的最小单位。「块」的大小，最常见的是 4KB，即连续 8 个扇区。
</p>

<p>
文件数据都储存在「块」中，除此之外还必须有一个地方储存文件的元信息，比如文件的创建者、创建日期、大小等等。这种 <span class="underline">储存文件元信息的区域就叫做 inode</span> ，中文译名为「索引节点」。每一个文件都有对应的 inode。
</p>
</div>
</div>

<div id="outline-container-org873eec6" class="outline-3">
<h3 id="org873eec6"><span class="section-number-3">3.2</span> inode 内容</h3>
<div class="outline-text-3" id="text-3-2">
<p>
inode 包含文件的元信息，具体来说有以下内容：
</p>

<ul class="org-ul">
<li>字节数</li>
<li>拥有者的 User ID</li>
<li>Group ID</li>
<li>读、写、执行权限</li>
<li>时间戳，共有三个：
<ul class="org-ul">
<li>ctime：inode 上一次变动的时间</li>
<li>mtime：文件内容上一次变动的时间</li>
<li>atime：文件上一次打开的时间</li>
</ul></li>
<li>链接数，即有多少文件名指向这个 inode</li>
<li>文件数据 block 的位置</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 23: </span>可以用 <code>stat</code> 命令查看某个文件的 inode 信息：</label><pre class="src src-sh">$ stat foo.bar

  File: &#8216;foo.bar&#8217;
  Size: 92              Blocks: 16         IO Block: 4096   regular file
Device: 811h/2065d      Inode: 11274707    Links: 1
Access: (0740/-rwxr-----)  Uid: (166645/alumapp2)   Gid: (  802/      a6)
Context: unconfined_u:object_r:user_home_t:s0
Access: 2016-11-07 10:25:23.903727528 -0400
Modify: 2016-09-02 08:40:28.265492387 -0300
Change: 2016-09-02 08:40:34.875042038 -0300
 Birth: -
</pre>
</div>
</div>
</div>
<div id="outline-container-orge3690a6" class="outline-3">
<h3 id="orge3690a6"><span class="section-number-3">3.3</span> inode 大小</h3>
<div class="outline-text-3" id="text-3-3">
<p>
<span class="underline">硬盘格式化的时候，操作系统自动将硬盘分成两个区域：一个是数据区，存放文件数据；另一个是 inode 区（inode table），存放 inode 所包含的信息。</span>
</p>

<p>
inode 也会消耗硬盘空间。每个 inode 节点的大小，一般是 128 字节或 256 字节。 <span class="underline">inode 节点的总数，在格式化时就给定，一般是每 1KB 或每 2KB 就设置一个 inode。</span> 假定在一块 1GB 的硬盘中，每个 inode 节点的大小为 128 字节，每 1KB 就设置一个 inode，那么 inode table 的大小就会达到 128MB，占整块硬盘的 12.8%。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 24: </span>查看每个硬盘分区的 inode 总数和已经使用的数量，可以使用 <code>df</code> 命令：</label><pre class="src src-sh">$ df -i

Filesystem       Inodes  IUsed    IFree IUse% Mounted on
/dev/sda1        960992 146095   814897   16% /
tmpfs           1001351    568  1000783    1% /run
/dev/sda3        512064   7123   504941    2% /var
/dev/sda2        640848   4264   636584    1% /var/local
...
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 25: </span>查看每个 inode 节点的大小：</label><pre class="src src-sh">$ sudo dumpe2fs -h /dev/hda | grep <span class="org-string">"Inode size"</span>

dumpe2fs 1.41.14 (22-Dec-2010)
Inode size:               256
</pre>
</div>

<p>
由于每个文件都必须有一个 inode，因此 <span class="underline">有可能发生 inode 已经用光，但是硬盘还未存满的情况。这时，就无法在硬盘上创建新文件。</span>
</p>
</div>
</div>

<div id="outline-container-org95a879e" class="outline-3">
<h3 id="org95a879e"><span class="section-number-3">3.4</span> inode 编号</h3>
<div class="outline-text-3" id="text-3-4">
<p>
每个 inode 都有一个编号， <span class="underline">Unix/Linux 系统内部不使用文件名，而使用 inode 编号来识别文件。</span> 对于系统来说，文件名只是 inode 号码便于识别的别称。表面上，用户通过文件名，打开文件。实际上，系统内部这个过程分成三步：
</p>

<ol class="org-ol">
<li>找到文件名对应的 inode 编号。</li>
<li>通过 inode 编号，获取 inode 信息。</li>
<li>根据 inode 信息找到文件数据所在的 block，读出数据。</li>
</ol>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 26: </span>使用 <code>ls -i</code> 命令，可以查看文件名对应的 inode 编号：</label><pre class="src src-sh">$ ls -i foo.bar

11274707 foo.bar
</pre>
</div>
</div>
</div>
<div id="outline-container-org7e527e0" class="outline-3">
<h3 id="org7e527e0"><span class="section-number-3">3.5</span> 目录文件</h3>
<div class="outline-text-3" id="text-3-5">
<p>
Unix/Linux 系统中，目录（directory）也是一种文件。打开目录，实际上就是打开目录文件。 <span class="underline">目录文件的结构非常简单，就是目录项（dirent）的列表。</span> 每个目录项，由两部分组成：
</p>

<ul class="org-ul">
<li>所包含文件的文件名</li>
<li>文件名对应的 inode 编号</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 27: </span><code>ls -i</code> 命令列出整个目录文件，即文件名和 inode 编号：</label><pre class="src src-sh">$ ls -i foo

11274150 foo.1  11274149 foo.2  11274045 foo.3
</pre>
</div>

<p>
如果要查看文件的详细信息，就必须根据 inode 编号，访问 inode 节点，读取信息。目录文件的读权限和写权限，都是针对目录文件本身。 <span class="underline">由于目录文件内只有文件名和 inode 号码，所以如果只有读权限，只能获取文件名，无法获取其他信息，而读取 inode 节点内的信息需要目录文件的执行权限。</span>
</p>
</div>
</div>

<div id="outline-container-org7dcccbc" class="outline-3">
<h3 id="org7dcccbc"><span class="section-number-3">3.6</span> 硬链接</h3>
<div class="outline-text-3" id="text-3-6">
<p>
文件名一般和 inode 编号一一对应，但 <span class="underline">Unix/Linux 系统允许多个文件名指向同一个 inode 号码，即可以用不同的文件名访问同样的内容；对文件内容进行修改，会影响到所有文件名；但是删除一个文件名，不影响另一个文件名的访问。这种情况就被称为「硬链接」（hard link）。</span>
</p>

<p>
建立硬链接时，inode 信息中有一项链接数，记录指向该 inode 的文件名总数，这时就会增加 1。反过来， <span class="underline">删除一个文件名，会使 inode 节点中的链接数减 1。当这个值减到 0，系统就会回收这个 inode 号码，以及其所对应 block 区域。</span>
</p>

<p>
关于目录文件的链接数，创建目录时，默认会生成两个目录项：<code>.</code> 和 <code>..</code> 。前者的 inode 编号是当前目录的 inode 编号，等同于当前目录的硬链接；后者的 inode 编号是当前目录的父目录的 inode 编号，等同于父目录的硬链接。所以，任何一个目录的硬链接总数，总是等于 2 加上它的子目录总数（含隐藏目录）。
</p>
</div>
</div>

<div id="outline-container-org90b7131" class="outline-3">
<h3 id="org90b7131"><span class="section-number-3">3.7</span> 软链接</h3>
<div class="outline-text-3" id="text-3-7">
<p>
除了硬链接以外，还有一种特殊情况： <span class="underline">文件 A 和文件 B 的 inode 编号不同，文件 A 的内容是文件 B 的路径。读取文件 A 时，系统会自动将访问者导向文件 B。</span> 因此，无论打开哪一个文件，最终读取的都是文件 B。 <span class="underline">文件 A 称为文件 B 的「软链接」（soft link）或者「符号链接」（symbolic link）。</span>
</p>

<p>
这意味着， <span class="underline">文件 A 依赖于文件 B 而存在，如果删除了文件 B，打开文件 A 就会报错。文件 A 指向文件 B 的文件名，而不是文件 B 的 inode 编号，文件 B 的 inode 链接数不会增加。</span>
</p>
</div>
</div>

<div id="outline-container-org7aa0075" class="outline-3">
<h3 id="org7aa0075"><span class="section-number-3">3.8</span> inode 的特殊作用</h3>
<div class="outline-text-3" id="text-3-8">
<p>
由于 inode 编号与文件名分离，这种机制导致了一些 Unix/Linux 系统特有的现象。
</p>

<ol class="org-ol">
<li>如果文件名包含特殊字符，无法正常删除，直接删除 inode 节点，就能起到删除文件的作用。</li>
<li><span class="underline">移动或重命名文件，只改变文件名，不影响 inode 编号。</span></li>
<li>打开一个文件以后，系统就以 inode 编号来识别这个文件，不再考虑文件名。因此，通常来说，系统无法从 inode 编号得知文件名。这使得软件更新变得简单， <span class="underline">可以在不关闭软件的情况下进行更新，不需要重启。因为系统通过 inode 号码而不是文件名识别运行中的文件。更新的时候，新版文件以同样的文件名生成一个新的 inode，不会影响到运行中的文件。下一次运行这个软件的时候，文件名就自动指向新版文件，旧版文件的 inode 则被回收。</span></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org2d60306" class="outline-2">
<h2 id="org2d60306"><span class="section-number-2">4</span> systemd 入门（未完成）</h2>
<div class="outline-text-2" id="text-4">
<p>
<a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html">Source</a> <br />
<a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html">Source</a>
</p>

<p>
systemd 是 Linux 系统工具，用来启动守护进程，已成为大多数发行版的标准配置。
</p>
</div>

<div id="outline-container-orgdffd73a" class="outline-3">
<h3 id="orgdffd73a"><span class="section-number-3">4.1</span> 历史</h3>
<div class="outline-text-3" id="text-4-1">
<p>
历史上，Linux 的启动一直采用 init 进程。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 28: </span>启动服务命令</label><pre class="src src-sh">$ sudo /etc/init.d/apache2 start
$ service apache2 start
</pre>
</div>

<p>
这种方式的缺点：
</p>

<ul class="org-ul">
<li>启动时间长。init 进程是串行的，前一个进程启动完，才会启动下一个进程。</li>
<li>启动脚本复杂。init 进程只执行启动脚本，不负责其他事情，脚本需要自己处理各种意外情况，使得脚本变得很长。</li>
</ul>
</div>
</div>

<div id="outline-container-org0516759" class="outline-3">
<h3 id="org0516759"><span class="section-number-3">4.2</span> 概述</h3>
<div class="outline-text-3" id="text-4-2">
<p>
systemd 就是为了解决 init 的问题而诞生的，它的设计目标是，为系统的启动和管理提供一套完整的解决方案。
</p>

<p>
根据 Linux 惯例，字母 d 是守护进程（daemon）的缩写，systemd 这个名字的含义，就是要守护整个系统。使用了 systemd，就不需要再用 init 了。 <span class="underline">systemd 取代 initd 成为系统的第一个进程（PID = 1），其他进程都是它的子进程。</span>
</p>

<p>
systemd 的优点是功能强大，使用方便，缺点是体系庞大，非常复杂。事实上，现在还有很多人反对使用 systemd，理由就是它 <span class="underline">过于复杂，与操作系统的其他部分强耦合，</span> 违反「keep it stupid simple」的 Unix 哲学。
</p>


<div class="figure">
<p><img src="../images/linux_scrap/06.png" alt="06.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org362f025" class="outline-3">
<h3 id="org362f025"><span class="section-number-3">4.3</span> 系统管理命令</h3>
<div class="outline-text-3" id="text-4-3">
<p>
systemd 并不是一个命令，而是一组命令，涉及到系统管理的方方面面。
</p>
</div>

<div id="outline-container-orgc722767" class="outline-4">
<h4 id="orgc722767"><span class="section-number-4">4.3.1</span> <code>systemctl</code></h4>
<div class="outline-text-4" id="text-4-3-1">
<p>
<code>systemctl</code> 是 systemd 的主命令，用于管理系统。
</p>

<div class="org-src-container">
<pre class="src src-sh">$ sudo systemctl reboot       <span class="org-comment-delimiter"># </span><span class="org-comment">&#37325;&#21551;</span>
$ sudo systemctl poweroff     <span class="org-comment-delimiter"># </span><span class="org-comment">&#20851;&#26426;&#65288;&#20999;&#26029;&#30005;&#28304;&#65289;</span>
$ sudo systemctl halt         <span class="org-comment-delimiter"># </span><span class="org-comment">CPU &#20572;&#27490;&#24037;&#20316;</span>
$ sudo systemctl suspend      <span class="org-comment-delimiter"># </span><span class="org-comment">&#26242;&#20572;&#31995;&#32479;</span>
$ sudo systemctl hibernate    <span class="org-comment-delimiter"># </span><span class="org-comment">&#20241;&#30496;</span>
$ sudo systemctl hybrid-sleep <span class="org-comment-delimiter"># </span><span class="org-comment">&#20132;&#20114;&#24335;&#20241;&#30496;</span>
$ sudo systemctl rescue       <span class="org-comment-delimiter"># </span><span class="org-comment">&#25937;&#25588;&#29366;&#24577;&#65288;&#21333;&#29992;&#25143;&#29366;&#24577;&#65289;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org392a8bd" class="outline-4">
<h4 id="org392a8bd"><span class="section-number-4">4.3.2</span> <code>systemd-analyze</code></h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
<code>systemd-analyze</code> 命令用于查看启动耗时。
</p>

<div class="org-src-container">
<pre class="src src-sh">$ systemd-analyze       <span class="org-comment-delimiter"># </span><span class="org-comment">&#26597;&#30475;&#21551;&#21160;&#32791;&#26102;</span>
$ systemd-analyze blame <span class="org-comment-delimiter"># </span><span class="org-comment">&#26597;&#30475;&#27599;&#20010;&#26381;&#21153;&#30340;&#21551;&#21160;&#32791;&#26102;</span>

$ systemd-analyze critical-chain             <span class="org-comment-delimiter"># </span><span class="org-comment">&#26174;&#31034;&#28689;&#24067;&#29366;&#30340;&#21551;&#21160;&#36807;&#31243;</span>
$ systemd-analyze critical-chain atd.service <span class="org-comment-delimiter"># </span><span class="org-comment">&#26174;&#31034;&#25351;&#23450;&#26381;&#21153;&#30340;&#21551;&#21160;&#36807;&#31243;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgde9d776" class="outline-4">
<h4 id="orgde9d776"><span class="section-number-4">4.3.3</span> <code>hostnamectl</code></h4>
<div class="outline-text-4" id="text-4-3-3">
<p>
<code>hostnamectl</code> 命令用于查看、设置主机信息。
</p>

<div class="org-src-container">
<pre class="src src-sh">$ hostnamectl <span class="org-comment-delimiter"># </span><span class="org-comment">&#26174;&#31034;&#24403;&#21069;&#20027;&#26426;&#30340;&#20449;&#24687;</span>

$ sudo hostnamectl set-hostname rhel7 <span class="org-comment-delimiter"># </span><span class="org-comment">&#35774;&#32622;&#20027;&#26426;&#21517;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5e1e67d" class="outline-4">
<h4 id="org5e1e67d"><span class="section-number-4">4.3.4</span> <code>localectl</code></h4>
<div class="outline-text-4" id="text-4-3-4">
<p>
<code>localectl</code> 命令用于查看、设置本地化参数。
</p>

<div class="org-src-container">
<pre class="src src-sh">$ localectl <span class="org-comment-delimiter"># </span><span class="org-comment">&#26597;&#30475;&#26412;&#22320;&#21270;&#21442;&#25968;</span>

$ sudo localectl set-locale <span class="org-variable-name">LANG</span>=en_GB.utf8 <span class="org-comment-delimiter"># </span><span class="org-comment">&#35774;&#32622;&#26412;&#22320;&#21270;&#21442;&#25968;</span>
$ sudo localectl set-keymap en_GB
</pre>
</div>
</div>
</div>

<div id="outline-container-orge801fb2" class="outline-4">
<h4 id="orge801fb2"><span class="section-number-4">4.3.5</span> <code>timedatectl</code></h4>
<div class="outline-text-4" id="text-4-3-5">
<p>
<code>timedatectl</code> 命令用于查看、设置当前时区、日期时间。
</p>

<div class="org-src-container">
<pre class="src src-sh">$ timedatectl                <span class="org-comment-delimiter"># </span><span class="org-comment">&#26597;&#30475;&#24403;&#21069;&#26102;&#21306;&#35774;&#32622;</span>
$ timedatectl list-timezones <span class="org-comment-delimiter"># </span><span class="org-comment">&#26174;&#31034;&#25152;&#26377;&#21487;&#29992;&#30340;&#26102;&#21306;</span>

$ sudo timedatectl set-timezone America/New_York <span class="org-comment-delimiter"># </span><span class="org-comment">&#35774;&#32622;&#24403;&#21069;&#26102;&#21306;</span>
$ sudo timedatectl set-time YYYY-MM-DD           <span class="org-comment-delimiter"># </span><span class="org-comment">&#35774;&#32622;&#26085;&#26399;</span>
$ sudo timedatectl set-time HH:MM:SS             <span class="org-comment-delimiter"># </span><span class="org-comment">&#35774;&#32622;&#26102;&#38388;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org099a24c" class="outline-4">
<h4 id="org099a24c"><span class="section-number-4">4.3.6</span> <code>loginctl</code></h4>
<div class="outline-text-4" id="text-4-3-6">
<p>
<code>loginctl</code> 命令用于查看当前登录的用户。
</p>

<div class="org-src-container">
<pre class="src src-sh">$ loginctl list-sessions <span class="org-comment-delimiter"># </span><span class="org-comment">&#21015;&#20986;&#24403;&#21069;&#20250;&#35805;</span>
$ loginctl list-users    <span class="org-comment-delimiter"># </span><span class="org-comment">&#21015;&#20986;&#24403;&#21069;&#30331;&#24405;&#29992;&#25143;</span>
$ loginctl show-user foo <span class="org-comment-delimiter"># </span><span class="org-comment">&#21015;&#20986;&#26174;&#31034;&#25351;&#23450;&#29992;&#25143;&#30340;&#20449;&#24687;</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org2ca3c5c" class="outline-2">
<h2 id="org2ca3c5c"><span class="section-number-2">5</span> Unix 目录结构的来历</h2>
<div class="outline-text-2" id="text-5">
<p>
Unix（包含 Linux）初学者常常会很困惑目录结构的含义。举例来说，根目录下有一个子目录 <code>/bin</code> ，用于存放二进制程序。但是， <code>/usr</code> 目录下也有 <code>/usr/bin</code> ，以及 <code>/usr/local/bin</code> ，也用于存放二进制程序；某些系统甚至还有 <code>/opt/bin</code> 。它们有何区别？
</p>

<p>
长久以来，我也不明白为什么这样设计，只是根据 <a href="http://www.pathname.com/fhs/pub/fhs-2.3.html">Filesystem Hierarchy Standard</a> 死记硬背不同目录的区别。昨天，我读到了 Rob Landley 的 <a href="http://lists.busybox.net/pipermail/busybox/2010-December/074114.html">Understanding the bin, sbin, usr/bin, usr/sbin split</a> ，这才恍然大悟，原来 Unix 目录结构是历史造成的。
</p>

<p>
1969 年，Ken Thompson 和 Dennis Ritchie 在小型机 PDP-7 上发明了 Unix。1971 年，他们将主机升级到了 PDP-11。当时，他们使用一种叫做 RK05 的储存盘，容量大约是 1.5MB。
</p>

<p>
没过多久，操作系统（根目录）变得越来越大，一块盘已经装不下了。于是，他们加上了第二块 RK05，并且规定第一块盘专门放系统程序，第二块盘专门放用户自己的程序，因此挂载的目录点取名为 <code>/usr</code> 。也就是说，根目录 <code>/</code> 挂载在第一块盘， <code>/usr</code> 目录挂载在第二块盘。除此之外，两块盘的目录结构完全相同，第一块盘的目录（ <code>/bin</code> ， <code>/sbin</code> ， <code>/lib</code> ， <code>/tmp</code> 等）都在 <code>/usr</code> 目录下重新出现一次。后来，第二块盘也满了，他们只好又加了第三块 RK05，挂载的目录点取名为 <code>/home</code> ，并且规定 <code>/usr</code> 用于存放用户的程序， <code>/home</code> 用于存放用户的数据。
</p>

<p>
从此，这种目录结构就延续了下来。随着硬盘容量越来越大，各个目录的含义进一步得到明确。
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides" class="no-border dense">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left"><code>/</code></th>
<th scope="col" class="org-left">存放系统程序，也就是 AT&amp;T 开发的 Unix 程序</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>/usr</code></td>
<td class="org-left">存放 Unix 系统商（比如 IBM 和 HP）开发的程序</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><code>/usr/local</code></td>
<td class="org-left">存放用户自己安装的程序</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><code>/opt</code></td>
<td class="org-left">在某些系统下，用于存放第三方厂商开发的程序，所以取名为 optional</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgf4c2d65" class="outline-2">
<h2 id="orgf4c2d65"><span class="section-number-2">6</span> Linux 系统负荷</h2>
<div class="outline-text-2" id="text-6">
<p>
<a href="http://www.ruanyifeng.com/blog/2011/07/linux_load_average_explained.html">Source</a>
</p>
</div>

<div id="outline-container-org5dd1525" class="outline-3">
<h3 id="org5dd1525"><span class="section-number-3">6.1</span> 查看系统负荷</h3>
<div class="outline-text-3" id="text-6-1">
<p>
在 Linux 系统中，一般使用 <code>uptime</code> 命令查看系统负荷（ <code>w</code> 命令和 <code>top</code> 命令也行）。
</p>

<div class="org-src-container">
<pre class="src src-sh">$ uptime
12:28:20 up 11 days,  5:27,  2 users,  load average: 0.77, 0.68, 0.71
</pre>
</div>

<p>
「平均负荷」的三个数字分别是 1 分钟、5 分钟、15 分钟内系统的平均负荷。
</p>

<ul class="org-ul">
<li>当 CPU 完全空闲的时候，平均负荷为 0</li>
<li>当 CPU 工作量饱和的时候，平均负荷为 1。</li>
</ul>
</div>
</div>

<div id="outline-container-org692ad80" class="outline-3">
<h3 id="org692ad80"><span class="section-number-3">6.2</span> 一个类比</h3>
<div class="outline-text-3" id="text-6-2">
<p>
下面根据 <a href="http://blog.scoutapp.com/articles/2009/07/31/understanding-load-averages">Understanding Linux CPU Load</a> 这篇文章，来具体解释平均负荷的问题。
</p>

<p>
首先，假设最简单的情况，电脑只有一个 CPU，所有的运算都由这个 CPU 来完成。不妨把这个 CPU 想象成一座大桥，桥上只有一条车道，所有车辆都必须从这条车道上通过。
</p>

<p>
系统负荷为 0，意味着大桥上一辆车也没有。
</p>


<div class="figure">
<p><img src="../images/linux_scrap/01.png" alt="01.png" />
</p>
</div>

<p>
系统负荷为 0.5，意味着大桥一半的路段有车。
</p>


<div class="figure">
<p><img src="../images/linux_scrap/02.png" alt="02.png" />
</p>
</div>

<p>
系统负荷为 1.0，意味着大桥的所有路段都有车，也就是说大桥已经「满」了。但是必须注意的是，直到此时大桥还是能顺畅通行的。
</p>


<div class="figure">
<p><img src="../images/linux_scrap/03.png" alt="03.png" />
</p>
</div>

<p>
系统负荷为 1.7，意味着车辆太多了，后面等着上桥的车辆为桥面车辆的 70%。以此类推，系统负荷 2.0，意味着等待上桥的车辆与桥面的车辆一样多。总之，当系统负荷大于 1，后面的车辆就必须等待了；系统负荷越大，过桥就必须等得越久。
</p>


<div class="figure">
<p><img src="../images/linux_scrap/04.png" alt="04.png" />
</p>
</div>

<p>
CPU 的系统负荷，基本上等同于上面的类比。大桥的通行能力，就是 CPU 的最大工作量；桥梁上的车辆，就是一个个等待 CPU 处理的进程。
</p>

<p>
如果 CPU 每分钟最多处理 100 个进程，那么：
</p>

<ul class="org-ul">
<li>系统负荷 0.2，意味着 CPU 在这 1 分钟里只处理 20 个进程。</li>
<li>系统负荷 1.0，意味着 CPU 在这 1 分钟里正好处理 100 个进程。</li>
<li><span class="underline">系统负荷 1.7，意味着除了 CPU 正在处理的 100 个进程以外，还有 70 个进程正排队等着 CPU 处理。</span></li>
</ul>

<p>
很显然，1.0 是一个关键值，超过这个值，系统就不在最佳状态了，需要手动干预。
</p>
</div>
</div>

<div id="outline-container-org96d4f9c" class="outline-3">
<h3 id="org96d4f9c"><span class="section-number-3">6.3</span> 系统负荷的经验法则</h3>
<div class="outline-text-3" id="text-6-3">
<p>
1.0 是系统负荷的理想值吗？不一定，系统管理员往往会留一点余地，当这个值达到 0.7，就应当引起注意了。经验法则是这样的：
</p>

<ul class="org-ul">
<li>当系统负荷持续大于 0.7，必须开始调查，问题出在哪里，防止情况恶化。</li>
<li>当系统负荷持续大于 1.0，必须动手寻找解决办法，把这个值降下来。</li>
<li>当系统负荷达到 5.0，表明系统有很严重的问题，长时间没有响应，或者接近死机了。</li>
</ul>
</div>
</div>

<div id="outline-container-orgcfc6e84" class="outline-3">
<h3 id="orgcfc6e84"><span class="section-number-3">6.4</span> 多处理器</h3>
<div class="outline-text-3" id="text-6-4">
<p>
两个 CPU，意味着电脑的处理能力翻了一倍，能够同时处理的进程数量也翻了一倍。还是用大桥来类比，两个 CPU 就意味着大桥有两条车道了，通车能力翻倍了。
</p>


<div class="figure">
<p><img src="../images/linux_scrap/05.png" alt="05.png" />
</p>
</div>

<p>
所以，两个 CPU 表明系统负荷可以达到 2.0，此时每个 CPU 都达到 100% 的工作量。推广开来，N 个 CPU 的电脑，可接受的系统负荷最大为 N.0。
</p>
</div>
</div>

<div id="outline-container-orgc8783ea" class="outline-3">
<h3 id="orgc8783ea"><span class="section-number-3">6.5</span> 多核处理器</h3>
<div class="outline-text-3" id="text-6-5">
<p>
芯片厂商往往在一个 CPU 内部，包含多个 CPU 核心，这被称为多核 CPU。
</p>

<p>
在系统负荷方面，多核 CPU 与多 CPU 效果类似，所以考虑系统负荷的时候，必须考虑这台电脑有几个 CPU、每个 CPU 有几个核心。然后， <span class="underline">把系统负荷除以总的核心数，只要平均值不超过 1.0，就表明电脑正常运行</span> 。
</p>

<p>
<code>cat /proc/cpuinfo</code> 可以查看 CPU 信息。 <code>grep -c 'model name' /proc/cpuinfo</code> 可以返回 CPU 的总核心数。
</p>
</div>
</div>

<div id="outline-container-orgdcac93d" class="outline-3">
<h3 id="orgdcac93d"><span class="section-number-3">6.6</span> 最佳观察时长</h3>
<div class="outline-text-3" id="text-6-6">
<p>
最后一个问题， <code>uptime</code> 一共返回三个平均值：1 分钟、5 分钟、15 分钟系统负荷，应该参考哪个值？
</p>

<p>
如果只有 1 分钟的系统负荷大于 1.0，其他两个时间段都小于 1.0，这表明只是暂时现象，问题不大。如果 15 分钟内，平均系统负荷大于 1.0，表明问题持续存在，不是暂时现象。所以，应该 <span class="underline">主要观察 15 分钟系统负荷，将它作为电脑正常运行的指标</span> 。
</p>
</div>
</div>
</div>
<div id="outline-container-org0d7c8ba" class="outline-2">
<h2 id="org0d7c8ba"><span class="section-number-2">7</span> 用户态与内核态</h2>
<div class="outline-text-2" id="text-7">
<p>
<a href="http://www.ruanyifeng.com/blog/2016/12/user_space_vs_kernel_space.html">Source</a>
</p>

<ul class="org-ul">
<li>内核态（kernel space）是 Linux 内核的运行空间。</li>
<li>用户态（user space）是用户程序的运行空间。</li>
</ul>

<p>
处于安全的考虑，它们是隔离的， <span class="underline">即使用户程序崩溃，内核也不受影响。</span>
</p>

<p>
内核态可以执行任意命令，调用系统的一切资源。 <span class="underline">用户态只能执行简单的运算，不能直接调用系统资源，必须通过系统调用（system call），才能向内核发出指令。</span>
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 29: </span>代码示例</label><pre class="src src-python"><span class="org-builtin">str</span> = <span class="org-string">"my string"</span> <span class="org-comment-delimiter"># </span><span class="org-comment">&#29992;&#25143;&#24577;</span>
<span class="org-variable-name">x</span> = x + 2
<span class="org-builtin">file</span>.write(<span class="org-builtin">str</span>)   <span class="org-comment-delimiter"># </span><span class="org-comment">&#20999;&#25442;&#21040;&#20869;&#26680;&#24577;&#65288;&#20889;&#25991;&#20214;&#24517;&#39035;&#36890;&#36807;&#20869;&#26680;&#65289;</span>
<span class="org-variable-name">y</span> = x + 4         <span class="org-comment-delimiter"># </span><span class="org-comment">&#20999;&#25442;&#22238;&#29992;&#25143;&#24577;</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 30: </span>使用 <code>top</code> 命令查看 CPU 时间分配：</label><pre class="src src-sh">$ top
%Cpu(s): 19.7 us,  2.4 sy,  0.0 ni, 77.4 id,  0.1 wa,  0.0 hi,  0.3 si,  0.0 st
<span class="org-comment-delimiter">#        </span><span class="org-comment">|         |</span>
<span class="org-comment-delimiter">#        </span><span class="org-comment">|         +- CPU &#28040;&#32791;&#22312;&#20869;&#26680;&#24577;&#30340;&#26102;&#38388;&#30334;&#20998;&#27604;</span>
<span class="org-comment-delimiter">#        </span><span class="org-comment">+----------- CPU &#28040;&#32791;&#22312;&#29992;&#25143;&#24577;&#30340;&#26102;&#38388;&#30334;&#20998;&#27604;</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 31: </span>使用 <code>time</code> 查看单个程序的耗时：</label><pre class="src src-sh">$ time ./test.sh
real    0m0.018s <span class="org-comment-delimiter"># </span><span class="org-comment">&#31243;&#24207;&#36816;&#34892;&#30340;&#20840;&#37096;&#26102;&#38388;&#65292;&#21253;&#25324; CPU &#20999;&#25442;&#21435;&#25191;&#34892;&#20854;&#20182;&#20219;&#21153;&#30340;&#26102;&#38388;&#65292;&#26159;&#29992;&#25143;&#33021;&#24863;&#30693;&#21040;&#30340;&#26102;&#38388;</span>
user    0m0.003s <span class="org-comment-delimiter"># </span><span class="org-comment">&#31243;&#24207;&#22312;&#29992;&#25143;&#24577;&#30340;&#25191;&#34892;&#26102;&#38388;</span>
sys     0m0.005s <span class="org-comment-delimiter"># </span><span class="org-comment">&#31243;&#24207;&#22312;&#20869;&#26680;&#24577;&#30340;&#25191;&#34892;&#26102;&#38388;</span>
</pre>
</div>

<ul class="org-ul">
<li>单 CPU 的情况下， <code>user</code> 和 <code>sys</code> 之和一般小于 <code>real</code> 。</li>
<li>多 CPU 的情况下， <code>user</code> 和 <code>sys</code> 表示的是所有 CPU 的总耗时，所以它们的和可能大于 <code>real</code> 。</li>
</ul>
</div>

<div id="outline-container-org63940ea" class="outline-3">
<h3 id="org63940ea"><span class="section-number-3">7.1</span> 链接</h3>
<div class="outline-text-3" id="text-7-1">
<ol class="org-ol">
<li><a href="https://drawings.jvns.ca/userspace/">User space vs kernel space</a></li>
<li><a href="https://www.lifewire.com/linux-top-command-2201163">Using the Linux Top Command</a></li>
<li><a href="http://blog.scoutapp.com/articles/2015/02/24/understanding-linuxs-cpu-stats">Understanding Linux CPU stats</a></li>
<li><a href="http://stackoverflow.com/questions/556405/what-do-real-user-and-sys-mean-in-the-output-of-time1">What do 'real', 'user' and 'sys' mean in the output of time(1)?</a></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-org43a8b56" class="outline-2">
<h2 id="org43a8b56"><span class="section-number-2">8</span> Unix 版权史</h2>
<div class="outline-text-2" id="text-8">
<p>
<a href="http://www.ruanyifeng.com/blog/2010/03/unix_copyright_history.html">Source</a>
</p>

<p>
<span class="underline">Unix 是贝尔实验室员工 Ken Thompson 的个人项目</span> ，诞生于 1969 年。 由于贝尔实验室是 AT&amp;T（美国电话电报公司）的下属机构，所以 <span class="underline">Unix 的版权归 AT&amp;T 所有</span> 。
</p>

<p>
AT&amp;T 垄断了美国长途电话业务，所以美国司法部在 1958 年与它签了一个和解协议， <span class="underline">AT&amp;T 同意不进入计算机业，</span> 不销售任何与计算机有关的产品，以避免司法部起诉它违反《反垄断法》。Unix 是计算机的操作系统，所以 AT&amp;T 不能销售它， <span class="underline">任何要求得到源码的机构，都能免费得到</span> 。
</p>

<p>
加州大学伯克利分校得到源码后，为 Unix 添加了许多功能。然后在 <span class="underline">1979 年，加州大学伯克利分校推出了自家的 Unix 版本，取名为 Berkeley Software Distribution，简称 BSD</span> 。
</p>

<hr />

<p>
1974 年，美国司法部再次起诉 AT&amp;T 违反《反垄断法》。1982 年，哥伦比亚地区法庭判决 <span class="underline">AT&amp;T 败诉，必须被拆成 8 家小公司</span> 。但是，这个判决也意味着 1958 年的和解协议失效， <span class="underline">AT&amp;T 从此可以进入计算机业</span> 。
</p>

<p>
1983 年，AT&amp;T 发布了 Unix 最新版 System V，这是一个商业化版本，付费才能使用，并且不得传播源码。这个决定对 BSD 构成了限制，为了减少纠纷，伯克利分校规定，BSD 本身依然保持免费，但是只能提供给持有 AT&amp;T 源码许可的公司。不过，与此同时，伯克利的师生也开始着手另一项工作：将 AT&amp;T 的专有代码从 BSD 中逐渐去除。
</p>

<p>
80 年代后期，几个伯克利毕业的学生，成立了一家 Berkeley Software Design Inc. 公司，简称 BSDi，专门销售 BSD 的一个商业版本。他们在广告中宣称，自己的产品不包含任何 AT&amp;T 代码。这句话惹恼了 AT&amp;T，1990 年 BSDi 被告上法庭，稍后伯克利分校也被追加为被告。 <span class="underline">AT&amp;T 起诉 BSD 侵犯了 Unix 的版权</span> 。
</p>

<p>
这场诉讼对 BSD 打击极大，所有的开发活动都被迫停止，用户人心惶惶，担心自己也遭到 AT&amp;T 的追究，因此 BSD 的使用急剧减少。最后在 1994 年，双方达到和解，BSD 才恢复开发。
</p>

<hr />

<p>
AT&amp;T 与 BSD 之间的诉讼，是当代版权制度最恶劣的应用之一。
</p>

<p>
首先，起诉者其实与 Unix 毫无关系。这是 AT&amp;T 经理层的决定，而不是开发者的决定。事实上，包括 Ken Thompson 在内的技术人员一直希望，公司能够公开源码。他们完全有理由这么要求，因为 <span class="underline">Unix 从来不是 AT&amp;T 的业务重点</span> ，最初是个人项目，后来也没有占用公司太多资源。销售 Unix 的利润，在公司全部业务中，几乎可以忽略不计。为了一点点钱，去打击一个使许多人受益的产品，何必这样做呢。
</p>

<p>
其次，AT&amp;T 根本不关心 Unix 的发展。它真正关心的是金钱和削弱对手。 <span class="underline">1994 年，官司还没有结束，AT&amp;T 就把 Unix 卖给了 Novell 公司，从此不再与 Unix 发生关系</span> ，官司也因此不了了之。既然你不想要这个产品，为什么要提起诉讼呢？真是不可理解。
</p>

<p>
最后，所谓的侵权几乎是不存在的。因为 Novell 从 AT&amp;T 买下 Unix 版权后，检查了 BSD 的源码，在 18000 个组成文件中删除了 3 个，并对其他文件做了一些小修改，然后 BSD 就重新获得了自由发布源码的许可。这意味着，至多只有千分之一的 BSD 代码有版权问题，但是就因为这千分之一的问题，导致百分之百的产品被迫中断。
</p>

<p>
所以，这场版权官司就是一家利益至上的公司，以微不足道的理由，为了一个自己根本不在乎的产品，悍然发动一场损人不利己的战争。
</p>

<hr />

<p>
这场战争给 Unix 和 BSD 带来毁灭性的打击。
</p>

<p>
<span class="underline">从 80 年代中后期开始，AT&amp;T 固执地捍卫 Unix 版权，完全不顾它的创造者和开发者的愿望，导致 Unix 丧失活力、一蹶不振，大量开发者无法参与，只好离开了这个平台。</span>
</p>

<p>
而 BSD 在 1992~1994 年期间，开发处于停滞，错过了发展的黄金时机。官司结束以后，又不幸发生分裂，变成了 FreeBSD、NetBSD 和 OpenBSD 三个版本。这些原因导致 BSD 直到今天，都还在操作系统的竞争中处在落后地位。
</p>

<p>
如果换个时间，官司的损失也许还没这么大。偏偏 90 年代初是计算机工业决定性的年代，错过了那几年，从此就不要想翻身了。因为从 <span class="underline">80 年代末期开始，Intel 的 80x86 芯片有了巨大的发展，性能快速上升，成本快速下降，个人电脑的年代就要到来，市场迫切需要能够运行在 386 芯片上的操作系统</span> ， 但是 Unix 和 BSD 忙于打官司，都没有去做移植操作系统这件事。其他两个这样做的人，改变了人类历史。
</p>

<p>
一个是比尔·盖茨，他推出了 Windows，占领了个人电脑市场，后来赚了几百亿美元。另一个是 <span class="underline">芬兰大学生 Linus Torvalds，他想学习 Unix，但是买不起工作站，就自己写了一个能在 386 上运行的 Linux 操作系统</span> ，现在全世界超过一半的网络服务器都在使用这个系统。
</p>

<p>
Linus Torvalds 后来说，如果他早知道 BSD 没有法律问题，并且可以被移植到 386，他就会加入 BSD 的开发，而不是自己写一个。如果 AT&amp;T 不打版权官司、不对 Unix 收费的话，会发生什么事？人类的历史、市场的格局也许都会被改写。
</p>

<hr />

<p>
Novell 买到 Unix 版权后，也没在手里放多久，1995 年又转手卖给了别人。从此， <span class="underline">Unix 原始版本的开发正式结束。以后的发展集中在两个方向，一个是各个商业公司自己修改的 Unix 版本，</span> 比如 Sun 的 Solaris，HP 的 HP-UX，IBM 的 AIX， <span class="underline">另一个则是开源项目的开发，比如 BSD 和 Linux。</span>
</p>
</div>
</div>
<div id="outline-container-orgc5b5353" class="outline-2">
<h2 id="orgc5b5353"><span class="section-number-2">9</span> 5 simple ways to troubleshoot using Strace</h2>
<div class="outline-text-2" id="text-9">
<p>
<a href="http://hokstad.com/5-simple-ways-to-troubleshoot-using-strace">Source</a>
</p>
</div>

<div id="outline-container-org1d8df5a" class="outline-3">
<h3 id="org1d8df5a"><span class="section-number-3">9.1</span> What is strace?</h3>
<div class="outline-text-3" id="text-9-1">
<p>
Strace is quite simply a tool that <span class="underline">traces the execution of system calls</span>. In its simplest form it can trace the execution of a binary from start to end, and output a line of text with the name of the system call, the arguments and the return value for every system call over the lifetime of the process. But it can do a lot more:
</p>

<ul class="org-ul">
<li>It can filter based on the specific system call or groups of system calls.</li>
<li>It can profile the use of system calls by tallying up the number of times a specific system call is used, and the time taken, and the number of successes and errors.</li>
<li>It traces signals sent to the process.</li>
<li>It can attach to any running process by pid.</li>
</ul>

<p>
If you've used other Unix systems, this is similar to <code>truss</code>. Another (much more comprehensive) is Sun's Dtrace.
</p>
</div>
</div>

<div id="outline-container-org1b1d67e" class="outline-3">
<h3 id="org1b1d67e"><span class="section-number-3">9.2</span> Find out which config files a program reads on startup</h3>
<div class="outline-text-3" id="text-9-2">
<p>
Ever tried figuring out why some program doesn't read the config file you thought it should? Had to wrestle with custom compiled or distro-specific binaries that read their config from what you consider the "wrong" location? The naive approach:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ strace php 2&gt;&amp;1 | grep php.ini
<span class="org-function-name">open</span>(<span class="org-string">"/usr/local/bin/php.ini"</span>, O_RDONLY) = -1 ENOENT (No such file or directory) <span class="org-comment-delimiter"># </span><span class="org-comment">First try</span>
<span class="org-function-name">open</span>(<span class="org-string">"/usr/local/lib/php.ini"</span>, O_RDONLY) = 4                                     <span class="org-comment-delimiter"># </span><span class="org-comment">Read config file</span>
<span class="org-function-name">lstat64</span>(<span class="org-string">"/usr/local/lib/php.ini"</span>, {<span class="org-variable-name">st_mode</span>=S_IFLNK|0777, <span class="org-variable-name">st_size</span>=27, ...}) = 0
<span class="org-function-name">readlink</span>(<span class="org-string">"/usr/local/lib/php.ini"</span>, <span class="org-string">"/usr/local/Zend/etc/php.ini"</span>, 4096) = 27
<span class="org-function-name">lstat64</span>(<span class="org-string">"/usr/local/Zend/etc/php.ini"</span>, {<span class="org-variable-name">st_mode</span>=S_IFREG|0664, <span class="org-variable-name">st_size</span>=40971, ...}) = 0
</pre>
</div>

<p>
The more sophisticated approach if I only care about a specific syscall:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ strace -e open php 2&gt;&amp;1 | grep php.ini
<span class="org-function-name">open</span>(<span class="org-string">"/usr/local/bin/php.ini"</span>, O_RDONLY) = -1 ENOENT (No such file or directory)
<span class="org-function-name">open</span>(<span class="org-string">"/usr/local/lib/php.ini"</span>, O_RDONLY) = 4
</pre>
</div>

<p>
The same approach work for a lot of other things. Have multiple versions of a library installed at different paths and wonder exactly which actually gets loaded? etc.
</p>
</div>
</div>

<div id="outline-container-org09963ed" class="outline-3">
<h3 id="org09963ed"><span class="section-number-3">9.3</span> Why does this program not open my file?</h3>
<div class="outline-text-3" id="text-9-3">
<p>
Ever run into a program that silently refuse to read a file it doesn't have read access to, but you only figured out after swearing for ages because you thought it didn't actually find the file? Well, you already know what to do:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ strace -e open,access 2&gt;&amp;1 | grep filename
<span class="org-comment-delimiter"># </span><span class="org-comment">Look for open or access syscall that fails</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd82a755" class="outline-3">
<h3 id="orgd82a755"><span class="section-number-3">9.4</span> What is that process doing right now?</h3>
<div class="outline-text-3" id="text-9-4">
<p>
Ever had a process suddenly hog lots of CPU? Or had a process seem to be hanging? Then you find the pid, and do this:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ strace -p 15427
Process 15427 attached - interrupt to quit
<span class="org-function-name">futex</span>(0x402f4900, FUTEX_WAIT, 2, NULL 
Process 15427 detached
</pre>
</div>

<p>
Ah. So in this case it's hanging in a call to <code>futex()</code>. Incidentally in this case it doesn't tell us all that much - hanging on a futex can be caused by a lot of things (a futex is a locking mechanism in the Linux kernel). The above is from a normally working but idle Apache child process that's just waiting to be handed a request. But <code>strace -p</code> is highly useful because it removes a lot of guesswork, and often removes the need for restarting an app with more extensive logging (or even recompile it).
</p>
</div>
</div>

<div id="outline-container-org5059695" class="outline-3">
<h3 id="org5059695"><span class="section-number-3">9.5</span> What is taking time?</h3>
<div class="outline-text-3" id="text-9-5">
<p>
You can always recompile an app with profiling turned on, and for accurate information, especially about what parts of your own code that is taking time that is what you should do. But often it is tremendously useful to be able to just quickly attach strace to a process to see what it's currently spending time on, especially to diagnose problems. Is that 90% CPU use because it's actually doing real work, or is something spinning out of control. Here's what you do:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ strace -c -p 11084
Process 11084 attached - interrupt to quit
Process 11084 detached
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 94.59    0.001014          48        21           select
  2.89    0.000031           1        21           getppid
  2.52    0.000027           1        21           time
------ ----------- ----------- --------- --------- ----------------
100.00    0.001072                    63           total
</pre>
</div>

<p>
After you've started <code>strace -c -p</code> you just wait for as long as you care to, and then exit with <code>Ctrl-C</code>. Strace will spit out profiling data as above. In this case, it's an idle Postgres <code>postmaster</code> process that's spending most of it's time quietly waiting in <code>select()</code>. In this case it's calling <code>getppid()</code> and <code>time()</code> in between each <code>select()</code> call, which is a fairly standard event loop. You can also run this "start to finish", here with <code>ls</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ strace -c &gt;/dev/null ls
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 23.62    0.000205         103         2           getdents64
 18.78    0.000163          15        11         1 open
 15.09    0.000131          19         7           read
 12.79    0.000111           7        16           old_mmap
...
------ ----------- ----------- --------- --------- ----------------
100.00    0.000868                    87        10 total
</pre>
</div>

<p>
Pretty much what you'd expect, it spents most of it's time in two calls to read the directory entries (only two since it was run on a small directory).
</p>
</div>
</div>

<div id="outline-container-orgd419ac0" class="outline-3">
<h3 id="orgd419ac0"><span class="section-number-3">9.6</span> Why can't I connect to that server?</h3>
<div class="outline-text-3" id="text-9-6">
<p>
Debugging why some process isn't connecting to a remote server can be exceedingly frustrating. DNS can fail, connect can hang, the server might send something unexpected back etc. You can use <code>tcpdump</code> to analyze a lot of that, but a lot of the time <code>strace</code> will give you less chatter, simply because it will only ever return data related to the syscalls generated by "your" process. If you're trying to figure out what one of hundreds of running processes connecting to the same database server does for example (where picking out the right connection with <code>tcpdump</code> is a nightmare), <code>strace</code> makes life a lot easier. This is an example of a trace of <code>nc</code> connecting to www.news.com on port 80 without any problems:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ strace -e poll,select,connect,recvfrom,sendto nc www.news.com 80
<span class="org-function-name">sendto</span>(3, <span class="org-string">"\\24\\0\\0\\0\\26\\0\\1\\3\\255\\373NH\\0\\0\\0\\0\\0\\0\\0\\0"</span>, 20, 0, {<span class="org-variable-name">sa_family</span>=AF_NETLINK, <span class="org-variable-name">pid</span>=0, <span class="org-variable-name">groups</span>=00000000}, 12) = 20
<span class="org-function-name">connect</span>(3, {<span class="org-variable-name">sa_family</span>=AF_FILE, <span class="org-variable-name">path</span>=<span class="org-string">"/var/run/nscd/socket"</span>}, 110) = -1 ENOENT (No such file or directory)
<span class="org-function-name">connect</span>(3, {<span class="org-variable-name">sa_family</span>=AF_FILE, <span class="org-variable-name">path</span>=<span class="org-string">"/var/run/nscd/socket"</span>}, 110) = -1 ENOENT (No such file or directory)
<span class="org-function-name">connect</span>(3, {<span class="org-variable-name">sa_family</span>=AF_INET, <span class="org-variable-name">sin_port</span>=htons(53), <span class="org-variable-name">sin_addr</span>=inet_addr(<span class="org-string">"62.30.112.39"</span>)}, 28) = 0
<span class="org-function-name">poll</span>([{<span class="org-variable-name">fd</span>=3, <span class="org-variable-name">events</span>=POLLOUT, <span class="org-variable-name">revents</span>=POLLOUT}], 1, 0) = 1
<span class="org-function-name">sendto</span>(3, <span class="org-string">"\\213\\321\\1\\0\\0\\1\\0\\0\\0\\0\\0\\0\\3www\\4news\\3com\\0\\0\\34\\0\\1"</span>, 30, MSG_NOSIGNAL, NULL, 0) = 30
<span class="org-function-name">poll</span>([{<span class="org-variable-name">fd</span>=3, <span class="org-variable-name">events</span>=POLLIN, <span class="org-variable-name">revents</span>=POLLIN}], 1, 5000) = 1
<span class="org-function-name">recvfrom</span>(3, <span class="org-string">"\\213\\321\\201\\200\\0\\1\\0\\1\\0\\1\\0\\0\\3www\\4news\\3com\\0\\0\\34\\0\\1\\300\\f"</span>..., 1024, 0, {<span class="org-variable-name">sa_family</span>=AF_INET, <span class="org-variable-name">sin_port</span>=htons(53), <span class="org-variable-name">sin_addr</span>=inet_addr(<span class="org-string">"62.30.112.39"</span>)}, [16]) = 153
<span class="org-function-name">connect</span>(3, {<span class="org-variable-name">sa_family</span>=AF_INET, <span class="org-variable-name">sin_port</span>=htons(53), <span class="org-variable-name">sin_addr</span>=inet_addr(<span class="org-string">"62.30.112.39"</span>)}, 28) = 0
<span class="org-function-name">poll</span>([{<span class="org-variable-name">fd</span>=3, <span class="org-variable-name">events</span>=POLLOUT, <span class="org-variable-name">revents</span>=POLLOUT}], 1, 0) = 1
<span class="org-function-name">sendto</span>(3, <span class="org-string">"k\\374\\1\\0\\0\\1\\0\\0\\0\\0\\0\\0\\3www\\4news\\3com\\0\\0\\1\\0\\1"</span>, 30, MSG_NOSIGNAL, NULL, 0) = 30
<span class="org-function-name">poll</span>([{<span class="org-variable-name">fd</span>=3, <span class="org-variable-name">events</span>=POLLIN, <span class="org-variable-name">revents</span>=POLLIN}], 1, 5000) = 1
<span class="org-function-name">recvfrom</span>(3, <span class="org-string">"k\\374\\201\\200\\0\\1\\0\\2\\0\\0\\0\\0\\3www\\4news\\3com\\0\\0\\1\\0\\1\\300\\f"</span>..., 1024, 0, {<span class="org-variable-name">sa_family</span>=AF_INET, <span class="org-variable-name">sin_port</span>=htons(53), <span class="org-variable-name">sin_addr</span>=inet_addr(<span class="org-string">"62.30.112.39"</span>)}, [16]) = 106
<span class="org-function-name">connect</span>(3, {<span class="org-variable-name">sa_family</span>=AF_INET, <span class="org-variable-name">sin_port</span>=htons(53), <span class="org-variable-name">sin_addr</span>=inet_addr(<span class="org-string">"62.30.112.39"</span>)}, 28) = 0
<span class="org-function-name">poll</span>([{<span class="org-variable-name">fd</span>=3, <span class="org-variable-name">events</span>=POLLOUT, <span class="org-variable-name">revents</span>=POLLOUT}], 1, 0) = 1
<span class="org-function-name">sendto</span>(3, <span class="org-string">"\\\\\\2\\1\\0\\0\\1\\0\\0\\0\\0\\0\\0\\3www\\4news\\3com\\0\\0\\1\\0\\1"</span>, 30, MSG_NOSIGNAL, NULL, 0) = 30
<span class="org-function-name">poll</span>([{<span class="org-variable-name">fd</span>=3, <span class="org-variable-name">events</span>=POLLIN, <span class="org-variable-name">revents</span>=POLLIN}], 1, 5000) = 1
<span class="org-function-name">recvfrom</span>(3, <span class="org-string">"\\\\\\2\\201\\200\\0\\1\\0\\2\\0\\0\\0\\0\\3www\\4news\\3com\\0\\0\\1\\0\\1\\300\\f"</span>..., 1024, 0, {<span class="org-variable-name">sa_family</span>=AF_INET, <span class="org-variable-name">sin_port</span>=htons(53), <span class="org-variable-name">sin_addr</span>=inet_addr(<span class="org-string">"62.30.112.39"</span>)}, [16]) = 106
<span class="org-function-name">connect</span>(3, {<span class="org-variable-name">sa_family</span>=AF_INET, <span class="org-variable-name">sin_port</span>=htons(80), <span class="org-variable-name">sin_addr</span>=inet_addr(<span class="org-string">"216.239.122.102"</span>)}, 16) = -1 EINPROGRESS (Operation now<span class="org-keyword"> in</span> progress)
<span class="org-keyword">select</span>(4, NULL, [3], NULL, NULL)        = 1 (out [3])
</pre>
</div>

<p>
So what happens here? Notice the connection attempts to <code>/var/run/nscd/socket</code>? They mean <code>nc</code> first tries to connect to NSCD - the Name Service Cache Daemon - which is usually used in setups that rely on NIS, YP, LDAP or similar directory protocols for name lookups. In this case the connects fails. It then moves on to DNS. DNS is port 53, hence the <code>sin_port=htons(53)</code> in the following connect. You can see it then does a <code>sendto()</code> call, sending a DNS packet that contains www.news.com. It then reads back a packet. For whatever reason it tries three times, the last with a slightly different request. My best guess why in this case is that www.news.com is a CNAME (an "alias"), and the multiple requests may just be an artifact of how <code>nc</code> deals with that. Then in the end, it finally issues a <code>connect()</code> to the IP it found. Notice it returns <code>EINPROGRESS</code>. That means the connect was non-blocking - <code>nc</code> wants to go on processing. It then calls <code>select()</code>, which succeeds when the connection was successful. Try adding <code>read</code> and <code>write</code> to the list of syscalls given to <code>strace</code> and enter a string when connected, and you'll get something like this:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-builtin">read</span>(0, <span class="org-string">"test\\n"</span>, 1024)                 = 5
<span class="org-function-name">write</span>(3, <span class="org-string">"test\\n"</span>, 5)                   = 5
<span class="org-function-name">poll</span>([{<span class="org-variable-name">fd</span>=3, <span class="org-variable-name">events</span>=POLLIN, <span class="org-variable-name">revents</span>=POLLIN}, {<span class="org-variable-name">fd</span>=0, <span class="org-variable-name">events</span>=POLLIN}], 2, -1) = 1
<span class="org-builtin">read</span>(3, <span class="org-string">"\"-//IETF//"</span>..., 1024) = 216
<span class="org-function-name">write</span>(1, <span class="org-string">"\"-//IETF//"</span>..., 216) = 216
</pre>
</div>

<p>
his shows it reading "test + linefeed" from standard in, and writing it back out to the network connection, then calling <code>poll()</code> to wait for a reply, reading the reply from the network connection and writing it to standard out. Everything seems to be working right.
</p>
</div>
</div>
</div>
<div id="outline-container-orgc992505" class="outline-2">
<h2 id="orgc992505"><span class="section-number-2">10</span> How to find out if a system uses SysV, Upstart or Systemd</h2>
<div class="outline-text-2" id="text-10">
<p>
<a href="https://unix.stackexchange.com/questions/196166/how-to-find-out-if-a-system-uses-sysv-upstart-or-systemd-initsystem">Source</a>
</p>

<p>
One way is to check for the existence of three directories:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides" class="no-border">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left"><code>/etc/init.d</code></th>
<th scope="col" class="org-left">SysV based system</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>/usr/lib/systemd</code></td>
<td class="org-left">Systemd based system</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><code>/usr/share/upstart</code></td>
<td class="org-left">Upstart based system</td>
</tr>
</tbody>
</table>

<p>
These are heuristics that must be considered together, possibly with other data, not certain indicators by themselves. Ubuntu 14.10 has all three directories. Because Ubuntu switched to Systemd from Upstart, but keeps Upstart and SysV for backwards compatibility.
</p>

<p>
Ways to tell exactly which one is being used:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ps -p 1
PID TTY          TIME CMD
  1 ?             ... systemd
$ ll /sbin/init
... /sbin/init -&gt; ../lib/systemd/systemd
$ sudo stat /proc/1/exe
File: &#8216;/proc/1/exe&#8217; -&gt; &#8216;/usr/lib/systemd/systemd&#8217;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd0afe53" class="outline-2">
<h2 id="orgd0afe53"><span class="section-number-2">11</span> Shared Libraries: Understanding Dynamic Loading</h2>
<div class="outline-text-2" id="text-11">
<p>
<a href="https://amir.rachum.com/blog/2016/09/17/shared-libraries/">Source</a>
</p>
</div>

<div id="outline-container-org2f8cc35" class="outline-3">
<h3 id="org2f8cc35"><span class="section-number-3">11.1</span> Shared Library</h3>
<div class="outline-text-3" id="text-11-1">
<p>
A library is a file that contains compiled code and data. Libraries in general are useful because they allow for fast compilation times (you don’t have to compile all sources of dependencies when compiling application) and modular development process.
</p>

<p>
<b>Static libraries</b> are linked into a compiled executable or another library. After compilation, the new artifact contains the static library’s content. <b>Shared libraries</b> are not linked into the compiled executable. They are loaded by the executable or other shared library at runtime.
</p>
</div>
</div>

<div id="outline-container-orge2ad3f7" class="outline-3">
<h3 id="orge2ad3f7"><span class="section-number-3">11.2</span> Example Setup</h3>
<div class="outline-text-3" id="text-11-2">
<p>
The main file of the executable just calls a function from a <code>random</code> library.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 32: </span><code>main.cpp</code></label><pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string">"random.h"</span>

<span class="org-type">int</span> <span class="org-function-name">main</span>() {
    <span class="org-keyword">return</span> get_random_number();
}
</pre>
</div>

<p>
The <code>random</code> library defines a function in its header file.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 33: </span><code>random.h</code></label><pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">get_random_number</span>();
</pre>
</div>

<p>
And implementation in its source file.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 34: </span><code>random.cpp</code></label><pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string">"random.h"</span>

<span class="org-type">int</span> <span class="org-function-name">get_random_number</span>(<span class="org-type">void</span>) {
    <span class="org-keyword">return</span> 4;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6e7c9f7" class="outline-3">
<h3 id="org6e7c9f7"><span class="section-number-3">11.3</span> Compiling Shared Library</h3>
<div class="outline-text-3" id="text-11-3">
<blockquote>
<p>
This example uses LLVM (clang) compiler instead of GCC to compile C++ code.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Create object file from source file</span>
$ clang++ -o random.o -c random.cpp
<span class="org-comment-delimiter"># </span><span class="org-comment">-o &lt;file&gt;  Output file</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">-c         No linking, just compiling</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Compile object file into shared library</span>
$ clang++ -shared -o librandom.so random.o
<span class="org-comment-delimiter"># </span><span class="org-comment">-shared  Build shared library</span>
</pre>
</div>

<p>
Shared library files should be named <code>lib&lt;name&gt;.so</code> for them to link properly.
</p>
</div>
</div>

<div id="outline-container-org7106ce2" class="outline-3">
<h3 id="org7106ce2"><span class="section-number-3">11.4</span> Compiling and Linking Dynamic Executable</h3>
<div class="outline-text-3" id="text-11-4">
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Create object file from source file</span>
$ clang++ -o main.o -c main.cpp

<span class="org-comment-delimiter"># </span><span class="org-comment">Create executable from object file</span>
$ clang++ -o main main.o
Undefined symbols for architecture x86_64:
  <span class="org-string">"get_random_number()"</span>, referenced from:
     _main<span class="org-keyword"> in</span> main.o
ld: symbol(s) not found for architecture x86_64
clang: error: linker command failed with exit code 1 (use -v to see invocation)
</pre>
</div>

<p>
Linker throws error because the shared library is not being linked. It is possible to link the library statically, but we choose to dynamically link <code>librandom.so</code> to <code>main</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh">$ clang++ -o main main.o -lrandom
<span class="org-comment-delimiter"># </span><span class="org-comment">-l&lt;library&gt;  Link library, the target library file is "lib&lt;library&gt;.so"</span>
ld: library not found for -lrandom
</pre>
</div>

<p>
Why does the compiler need this file at compile time when it is supposed to be loaded dynamically at runtime? Because the compiler needs to make sure that the dependent libraries contain all the symbols needed for the executable.
</p>

<p>
By using <code>-l</code> flag, we told compiler to look for a <code>librandom.so</code> file. We also need to tell compiler the location to search for this file, which can be done with <code>-L</code> flag:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ clang++ -o main main.o -lrandom -L.
<span class="org-comment-delimiter"># </span><span class="org-comment">-L&lt;path&gt;  Path to search for library</span>
</pre>
</div>

<p>
Run the executable:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./main
./main: error while loading shared libraries: librandom.so ... No such file or directory
</pre>
</div>

<p>
This error means a dependency can’t be located. It is thrown before the execution of the actual code, because shared libraries are loaded before symbols in the executable. Now the questions:
</p>

<ul class="org-ul">
<li>How does <code>main</code> know it depends on <code>librandom.so</code>?</li>
<li>Where does <code>main</code> look for <code>librandom.so</code>?</li>
<li>How to tell <code>main</code> the location to look for <code>librandom.so</code> at runtime?</li>
</ul>
</div>
</div>

<div id="outline-container-org0474ee2" class="outline-3">
<h3 id="org0474ee2"><span class="section-number-3">11.5</span> ELF (Executable and Linkable Format)</h3>
<div class="outline-text-3" id="text-11-5">
<blockquote>
<p>
Executable file format under Mac OS is Mach-O, instead of ELF under Linux, so the tool <code>readelf</code> doesn't exist under Mac OS. <a href="https://en.wikipedia.org/wiki/Comparison_of_executable_file_formats">Wikipedia | Comparison of executable file formats</a>
</p>
</blockquote>

<p>
The shared library and executable file format is called <a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">ELF (Executable and Linkable Format)</a>. In summary, an ELF file contains:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides" class="no-border">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left"><b>ELF header</b></th>
<th scope="col" class="org-left">Specifies the size and number of segments/sections in the program/section header table</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><b>Program header table</b></td>
<td class="org-left">Contains a list of segment headers</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><b>Section header table</b></td>
<td class="org-left">Contains a list of section headers</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><b>Data</b></td>
<td class="org-left">Data pointed to by the segment/section headers</td>
</tr>
</tbody>
</table>

<p>
Program/section header tables consist of fixed size segment/section headers. Each header contain a pointer (an offset in the file) to the location of the segment/section body, which exists in the data part of the file.
</p>

<p>
The difference between segment and section is that, section is a part of a segment, or a segment contains multiple sections. The same data is referenced as either part of a segment or a section depending on the current context: sections are used when linking, and segments are used when executing.
</p>


<div class="figure">
<p><img src="../images/linux_scrap/07.gif" alt="07.gif" />
</p>
</div>

<p>
Use <code>readelf</code> to read the ELF header of <code>main</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ readelf -h main
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF64
  ...
  Type:                              EXEC (Executable file)
  ...
  Number of program headers:         9
  Size of section headers:           64 (bytes)
  Number of section headers:         30
  ...
</pre>
</div>

<p>
And the program headers:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ readelf -l main

Elf file type is EXEC (Executable file)
Entry point 0x400530
There are 9 program headers, starting at offset 64

Program Headers:
  Type           Offset             VirtAddr           PhysAddr
                 FileSiz            MemSiz              Flags  Align
  ...
  DYNAMIC        0x0000000000000de8 0x0000000000600de8 0x0000000000600de8
                 0x0000000000000210 0x0000000000000210  RW     8
  ...

 Section to Segment mapping:
  Segment Sections...
   00
   ...
   08     .init_array .fini_array .dynamic .got
</pre>
</div>

<p>
And the section headers:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ readelf -S main
There are 30 section headers, starting at offset 0x1930:

Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  ...
  [21] .dynamic          DYNAMIC          0000000000600de8  00000de8
       0000000000000210  0000000000000010  WA       6     0     8
  ...
</pre>
</div>

<p>
As you can see, an ELF file has a segment of type <code>DYNAMIC</code> in its program header table. The <code>DYNAMIC</code> segment owns a <code>.dynamic</code> section, which contains useful information to understand dynamic dependencies.
</p>
</div>
</div>

<div id="outline-container-orgbed384e" class="outline-3">
<h3 id="orgbed384e"><span class="section-number-3">11.6</span> Direct Dependency</h3>
<div class="outline-text-3" id="text-11-6">
<p>
Use <code>readelf</code> to show all dynamic dependencies of <code>main</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ readelf -d main | grep NEEDED
 0x0000000000000001 (NEEDED)             Shared library: [librandom.so]
 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libgcc_s.so.1]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
</pre>
</div>

<p>
Except <code>librandom.so</code>, there are 4 other shared libraries in the result, these are the dependencies that appear in all compiled shared library. Use <code>objdump</code> to see a similar result by specifying <code>librandom.so</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ objdump -p librandom.so | grep NEEDED
  NEEDED               libstdc++.so.6
  NEEDED               libm.so.6
  NEEDED               libgcc_s.so.1
  NEEDED               libc.so.6
</pre>
</div>

<p>
These libraries are:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides" class="no-border">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left"><code>libstdc++</code></th>
<th scope="col" class="org-left">Standard C++ library</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>libm</code></td>
<td class="org-left">Library of basic math functions</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><code>libgcc_s</code></td>
<td class="org-left">GCC (GNU Compiler Collection) runtime library</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><code>libc</code></td>
<td class="org-left">C library, which defines system calls and basic facilities, e.g. <code>open</code> <code>malloc</code> <code>printf</code> <code>exit</code></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org6db8fac" class="outline-3">
<h3 id="org6db8fac"><span class="section-number-3">11.7</span> Runtime Search Path</h3>
<div class="outline-text-3" id="text-11-7">
<p>
Use <code>ldd</code> to see recursive shared library dependencies of <code>main</code>, and their locations:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ldd main
    linux-vdso.so.1 =&gt;  (0x00007fff373d7000)
    librandom.so =&gt; not found
    libstdc++.so.6 =&gt; /lib64/libstdc++.so.6 (0x00007fa1b674e000)
    libm.so.6 =&gt; /lib64/libm.so.6 (0x00007fa1b644c000)
    libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007fa1b6236000)
    libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fa1b5e68000)
    /lib64/ld-linux-x86-64.so.2 (0x00007fa1b6a55000)
</pre>
</div>

<p>
Note <code>librandom.so</code>'s location is <code>not found</code>, but not the others.
</p>

<p>
Each shared library in an executable's dependencies is searched in the following locations in order:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides" class="no-border">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">1. <code>rpath</code></th>
<th scope="col" class="org-left">Directories listed in the executable’s <code>rpath</code></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">2. <code>LD_LIBRARY_PATH</code></td>
<td class="org-left">Directories in the <code>LD_LIBRARY_PATH</code> environment variable</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">3. <code>runpath</code></td>
<td class="org-left">Directories listed in the executable’s <code>runpath</code></td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">4. <code>/etc/ld.so.conf</code></td>
<td class="org-left">Directories in the file <code>/etc/ld.so.conf</code></td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">5. <code>/lib</code> and <code>/usr/lib</code></td>
<td class="org-left">Default system libraries (skipped if compiled with <code>-z nodefaultlib</code>)</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgc8709db" class="outline-3">
<h3 id="orgc8709db"><span class="section-number-3">11.8</span> Fixing Dependency</h3>
<div class="outline-text-3" id="text-11-8">
<p>
Use <code>ldd</code> to see the search process of <code>librandom.so</code> when executing <code>main</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ <span class="org-variable-name">LD_DEBUG</span>=libs ldd main
        ...
        48: find <span class="org-variable-name">library</span>=librandom.so [0]; searching
        48:  search <span class="org-variable-name">path</span>=/opt/rh/llvm-toolset-7/root/usr/lib64/tls/x86_64:/opt/rh/llvm-toolset-7/root/usr/lib64/tls:/opt/rh/llvm-toolset-7/root/usr/lib64/x86_64:/opt/rh/llvm-toolset-7/root/usr/lib64      (LD_LIBRARY_PATH)
        48:   trying <span class="org-variable-name">file</span>=/opt/rh/llvm-toolset-7/root/usr/lib64/tls/x86_64/librandom.so
        48:   trying <span class="org-variable-name">file</span>=/opt/rh/llvm-toolset-7/root/usr/lib64/tls/librandom.so
        48:   trying <span class="org-variable-name">file</span>=/opt/rh/llvm-toolset-7/root/usr/lib64/x86_64/librandom.so
        48:   trying <span class="org-variable-name">file</span>=/opt/rh/llvm-toolset-7/root/usr/lib64/librandom.so
        48:  search <span class="org-variable-name">cache</span>=/etc/ld.so.cache
        48:  search <span class="org-variable-name">path</span>=/lib64/tls/x86_64:/lib64/tls:/lib64/x86_64:/lib64:/usr/lib64/tls/x86_64:/usr/lib64/tls:/usr/lib64/x86_64:/usr/lib64        (system search path)
        48:   trying <span class="org-variable-name">file</span>=/lib64/tls/x86_64/librandom.so
        48:   trying <span class="org-variable-name">file</span>=/lib64/tls/librandom.so
        48:   trying <span class="org-variable-name">file</span>=/lib64/x86_64/librandom.so
        48:   trying <span class="org-variable-name">file</span>=/lib64/librandom.so
        48:   trying <span class="org-variable-name">file</span>=/usr/lib64/tls/x86_64/librandom.so
        48:   trying <span class="org-variable-name">file</span>=/usr/lib64/tls/librandom.so
        48:   trying <span class="org-variable-name">file</span>=/usr/lib64/x86_64/librandom.so
        48:   trying <span class="org-variable-name">file</span>=/usr/lib64/librandom.so
        ...
</pre>
</div>

<p>
Note that <code>librandom.so</code> doesn't exist in any of these locations being searched. To fix this, the most ad-hoc way to solve this is to use <code>LD_LIBRARY_PATH</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ <span class="org-variable-name">LD_LIBRARY_PATH</span>=.
$ ./main
</pre>
</div>

<p>
This fix is not portable. A better way is to put dependencies inside the file, via <code>rpath</code> and <code>runpath</code>.
</p>
</div>
</div>

<div id="outline-container-org5060dfd" class="outline-3">
<h3 id="org5060dfd"><span class="section-number-3">11.9</span> <code>rpath</code> and <code>runpath</code></h3>
<div class="outline-text-3" id="text-11-9">
<p>
<code>rpath</code> and <code>runpath</code> are optional entries in the <code>.dynamic</code> section of an executable. They are lists of directories. The difference is <code>rpath</code> is searched before <code>LD_LIBRARY_PATH</code>, while <code>runpath</code> is searched after.
</p>

<p>
To bake <code>rpath</code> into the executable:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ clang++ -o main main.o -lrandom -L. -Wl,-rpath,.
<span class="org-comment-delimiter"># </span><span class="org-comment">-Wl,&lt;arg&gt;,&lt;arg&gt;...  Pass comma separated arguments to linker</span>
</pre>
</div>

<p>
<code>-Wl,-rpath,.</code> means passing <code>-rpath .</code> to the linker. Or to do the same thing for <code>runpath</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ clang++ -o main main.o -lrandom -L. -Wl,--enable-new-dtags,-rpath,.
</pre>
</div>

<p>
Check <code>.dynamic</code> section of <code>main</code> again:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ readelf -d main | grep path
 0x000000000000000f (RPATH)              Library rpath: [.]
</pre>
</div>

<p>
The downside of using <code>.</code> (the current working directory) as search path is that, it won't work when executing <code>main</code> from a different directory:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cd /tmp
$ /home/cpp/main
/home/cpp/main: error while loading shared libraries: librandom.so ...
</pre>
</div>

<p>
An easy way to solve this is to copy <code>librandom.so</code> to a directory that is on the search path, e.g. <code>/lib</code>. Another way is, of course, to set <code>rpath</code> to be relative to the executable, instead of the current location.
</p>
</div>
</div>

<div id="outline-container-orgda08b54" class="outline-3">
<h3 id="orgda08b54"><span class="section-number-3">11.10</span> <code>$ORIGIN</code></h3>
<div class="outline-text-3" id="text-11-10">
<p>
Paths in <code>rpath</code> and <code>runpath</code> can be:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides" class="no-border">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Absolute</th>
<th scope="col" class="org-left">E.g. <code>/path/to/my/libs</code></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Relative to current working directory</td>
<td class="org-left">E.g. <code>.</code></td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Relative to executable</td>
<td class="org-left">E.g. <code>$ORIGIN</code></td>
</tr>
</tbody>
</table>

<p>
<code>$ORIGIN</code> is not an environment variable, <code>export ORIGIN=/path</code> has no effect, it is always the directory in which the executable being executed is placed.
</p>

<p>
To use <code>$ORIGIN</code> in <code>rpath</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ clang++ -o main main.o -lrandom -L. -Wl,-rpath,<span class="org-string">"\$ORIGIN"</span>
</pre>
</div>

<p>
<code>$</code> needs to be escaped in this case, because we don't want Shell to expand it here. Then check the executable data:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ readelf main -d | grep path
 0x000000000000000f (RPATH)              Library rpath: [$<span class="org-variable-name">ORIGIN</span>]
$ ldd main | grep librandom
    librandom.so =&gt; /home/cpp/./librandom.so (0x00007f4ef0f20000)
</pre>
</div>

<p>
Now <code>main</code> works when being executed from any directory:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cd /tmp
$ /home/cpp/main
</pre>
</div>
</div>
</div>

<div id="outline-container-org9c5bdf5" class="outline-3">
<h3 id="org9c5bdf5"><span class="section-number-3">11.11</span> Runtime Search Path Security</h3>
<div class="outline-text-3" id="text-11-11">
<p>
Linux user password hash is stored in <code>/etc/shadow</code> and it's root protected. But a non-root user can change his password with <code>passwd</code>. The reason is that <code>passwd</code> executable has the <code>setuid</code> bit set:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ls -l /usr/bin/passwd
-rwsr-xr-x 1 root root 27832 Jun 10  2014 /usr/bin/passwd
<span class="org-comment-delimiter">#  </span><span class="org-comment">^--- The "setuid" bit is set for user execution.</span>
</pre>
</div>

<p>
A program with the <code>setuid</code> bit set is executed as the owner of that program, which in this example is root.
</p>

<p>
To demonstrate how this is relevant to the shared library, we move the library file to <code>libs/librandom.so</code> relative to <code>main</code>, and set the <code>rpath</code> accordingly:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ clang++ -o main main.o -lrandom -L. -Wl,-rpath,<span class="org-string">"\$ORIGIN/libs"</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">librandom.so needs to be in the same path when compiling, otherwise</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">linker doesn't know where to find it</span>
$ ldd main | grep librandom
    librandom.so =&gt; /home/cpp/./libs/librandom.so (0x00007f8868973000)
$ mkdir libs
$ mv librandom.so libs
$ ./main
<span class="org-comment-delimiter"># </span><span class="org-comment">main should execute without error</span>
</pre>
</div>

<p>
Turn on <code>setuid</code> bit for <code>main</code> and try execute it (as root):
</p>

<div class="org-src-container">
<pre class="src src-sh">$ sudo chown root main
$ sudo chmod a+s main

$ ./main
./main: error while loading shared libraries: librandom.so ...
<span class="org-comment-delimiter"># </span><span class="org-comment">rpath is not working</span>

$ <span class="org-variable-name">LD_LIBRARY_PATH</span>=./libs
$ ./main
./main: error while loading shared libraries: librandom.so ...
<span class="org-comment-delimiter"># </span><span class="org-comment">LD_LIBRARY_PATH is not working either</span>
</pre>
</div>

<p>
This is because, for security reasons, when running an executable with elevated privileges, e.g. <code>setuid</code> and <code>setgid</code>, the search path list is different than normal: <code>LD_LIBRARY_PATH</code>, <code>rpath</code> and <code>runpath</code> are all ignored, because using these search path allows exploit of elevated privileges executable to run as root, see <a href="https://marc.info/?l=full-disclosure&amp;m=128739684614072&amp;w=2">The GNU C library dynamic linker expands $ORIGIN in setuid library search path</a>.
</p>

<p>
Basically, it allows someone to make the elevated privileges executable load custom library, which will run as root (or a different user), and running code as root pretty much gives people absolute control over the machine.
</p>

<p>
Therefore, if the executable needs to have elevated privileges, the dependencies need to be specified in absolute paths, or placed in the default locations, e.g. <code>/lib</code>.
</p>
</div>
</div>

<div id="outline-container-org6e2c1b4" class="outline-3">
<h3 id="org6e2c1b4"><span class="section-number-3">11.12</span> Debugging Cheat Sheet</h3>
<div class="outline-text-3" id="text-11-12">
<p>
When seeing this error on running an executable:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./executable
./executable: error while loading shared libraries: ...
</pre>
</div>

<p>
Try these debugging steps:
</p>

<ol class="org-ol">
<li>Check what dependencies are missing with <code>ldd &lt;executable&gt;</code>.</li>
<li>Check if they are direct dependencies with <code>readelf -d &lt;executable&gt; | grep NEEDED</code>.</li>
<li>Check if the libraries actually exist in the expected location.</li>
<li>Check where dependencies are being searched with <code>LD_DEBUG=libs ldd &lt;executable&gt;</code>.</li>
<li>To add a directory to the search:
<ul class="org-ul">
<li>Add the directory to <code>LD_LIBRARY_PATH</code> environment variable.</li>
<li>Add the directory to the executable or shared library’s <code>rpath</code> (<code>-Wl,-rpath,&lt;dir&gt;</code>) or <code>runpath</code> (<code>-Wl,--enable-new-dtags,-rpath,&lt;dir&gt;</code>). Use <code>$ORIGIN</code> for paths relative to the executable.</li>
</ul></li>
<li>If <code>ldd</code> shows that no dependencies are missing, check if the executable has elevated privileges. If so, use absolute paths for dependencies.</li>
</ol>
</div>
</div>

<div id="outline-container-org06e5f3a" class="outline-3">
<h3 id="org06e5f3a"><span class="section-number-3">11.13</span> Links</h3>
<div class="outline-text-3" id="text-11-13">
<ol class="org-ol">
<li><a href="https://docs.oracle.com/cd/E23824_01/html/819-0690/chapter6-42444.html">Oracle | Linker and Libraries Guide</a></li>
<li><a href="https://www.gnu.org/software/libc/">The GNU C Library (glibc)</a></li>
<li><a href="http://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html">The Linux Documentation Project | Shared Libraries</a></li>
<li><a href="https://unix.stackexchange.com/questions/22926/where-do-executables-look-for-shared-objects-at-runtime">StackExchange | Where do executables look for shared objects at runtime?</a></li>
<li><a href="http://www.sco.com/developers/gabi/latest/ch5.pheader.html">System V Application Binary Interface | Program Header</a></li>
<li><a href="https://greek0.net/elf.html">The ELF format - how programs look from the inside</a></li>
<li><a href="https://en.wikipedia.org/wiki/Comparison_of_executable_file_formats">Wikipedia | Comparison of executable file formats</a></li>
<li><a href="https://clang.llvm.org/docs/ClangCommandLineReference.html#linker-flags">Clang command line argument reference | Linker flags</a></li>
</ol>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Victor Chen</p>
<p class="date">Created: 2019-11-23 Sat 20:51</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
